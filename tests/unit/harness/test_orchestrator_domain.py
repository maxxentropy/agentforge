# Generated by AgentForge
# Spec: agent_orchestrator
# Phase: red
# Date: 2025-12-31

"""
Tests for orchestrator domain entities.
These tests verify the structure and behavior of orchestrator domain objects
including enums, data classes, and configuration objects.
"""

import pytest
from datetime import datetime
from typing import Optional

from tools.harness.orchestrator_domain import (
    OrchestratorState,
    ExecutionMode,
    AgentTask,
    ExecutionResult,
    OrchestratorConfig
)


class TestOrchestratorState:
    """Test OrchestratorState enum values and behavior."""

    def test_orchestrator_state_has_all_required_values(self):
        """Test that OrchestratorState enum contains all specified values."""
        expected_values = {
            'IDLE', 'RUNNING', 'PAUSED', 'RECOVERING',
            'WAITING_FOR_HUMAN', 'COMPLETED', 'FAILED'
        }
        actual_values = {s.name for s in OrchestratorState}
        assert actual_values == expected_values

    def test_orchestrator_state_values_are_accessible(self):
        """Test that individual OrchestratorState values can be accessed."""
        assert OrchestratorState.IDLE
        assert OrchestratorState.RUNNING
        assert OrchestratorState.PAUSED
        assert OrchestratorState.RECOVERING
        assert OrchestratorState.WAITING_FOR_HUMAN
        assert OrchestratorState.COMPLETED
        assert OrchestratorState.FAILED


class TestExecutionMode:
    """Test ExecutionMode enum values and behavior."""

    def test_execution_mode_has_all_required_values(self):
        """Test that ExecutionMode enum contains all specified values."""
        expected_values = {'AUTONOMOUS', 'SUPERVISED', 'INTERACTIVE'}
        actual_values = {m.name for m in ExecutionMode}
        assert actual_values == expected_values

    def test_execution_mode_values_are_accessible(self):
        """Test that individual ExecutionMode values can be accessed."""
        assert ExecutionMode.AUTONOMOUS
        assert ExecutionMode.SUPERVISED
        assert ExecutionMode.INTERACTIVE


class TestAgentTask:
    """Test AgentTask entity structure and behavior."""

    def test_agent_task_creation_with_required_fields(self):
        """Test creating an AgentTask with required fields."""
        created_at = datetime.now()
        task = AgentTask(
            id="task-001",
            description="Implement feature X",
            context={"file": "main.py"},
            created_at=created_at
        )

        assert task.id == "task-001"
        assert task.description == "Implement feature X"
        assert task.context == {"file": "main.py"}
        assert task.created_at == created_at
        assert task.priority == 0  # default
        assert task.status == "pending"  # default
        assert task.started_at is None
        assert task.completed_at is None

    def test_agent_task_creation_with_all_fields(self):
        """Test creating an AgentTask with all fields."""
        created_at = datetime.now()
        started_at = datetime.now()
        completed_at = datetime.now()

        task = AgentTask(
            id="task-002",
            description="Fix bug Y",
            context={"error": "details"},
            priority=5,
            created_at=created_at,
            started_at=started_at,
            completed_at=completed_at,
            status="completed"
        )

        assert task.priority == 5
        assert task.started_at == started_at
        assert task.completed_at == completed_at
        assert task.status == "completed"

    def test_agent_task_context_can_be_complex(self):
        """Test that AgentTask context can hold complex data."""
        complex_context = {
            "files": ["a.py", "b.py"],
            "requirements": {"memory": "4GB"},
            "nested": {"deep": {"value": True}}
        }

        task = AgentTask(
            id="task-003",
            description="Complex task",
            context=complex_context,
            created_at=datetime.now()
        )

        assert task.context == complex_context

    def test_agent_task_priority_ordering(self):
        """Test that tasks can be ordered by priority."""
        task1 = AgentTask(id="t1", description="Low", context={}, priority=1, created_at=datetime.now())
        task2 = AgentTask(id="t2", description="High", context={}, priority=10, created_at=datetime.now())

        assert task1.priority < task2.priority


class TestExecutionResult:
    """Test ExecutionResult entity structure and behavior."""

    def test_execution_result_creation_success(self):
        """Test creating a successful ExecutionResult."""
        result = ExecutionResult(
            task_id="task-001",
            success=True,
            output="Task completed successfully",
            error=None,
            duration_seconds=5.5,
            tools_used=["read_file", "write_file"]
        )

        assert result.task_id == "task-001"
        assert result.success is True
        assert result.output == "Task completed successfully"
        assert result.error is None
        assert result.duration_seconds == 5.5
        assert result.tools_used == ["read_file", "write_file"]
        assert result.tokens_consumed == 0  # default

    def test_execution_result_creation_failure(self):
        """Test creating a failed ExecutionResult."""
        result = ExecutionResult(
            task_id="task-002",
            success=False,
            output=None,
            error="Connection timeout",
            duration_seconds=30.0,
            tools_used=["api_call"],
            tokens_consumed=150
        )

        assert result.success is False
        assert result.error == "Connection timeout"
        assert result.tokens_consumed == 150

    def test_execution_result_empty_tools_list(self):
        """Test ExecutionResult with no tools used."""
        result = ExecutionResult(
            task_id="task-003",
            success=True,
            output="Done",
            error=None,
            duration_seconds=0.1,
            tools_used=[]
        )

        assert result.tools_used == []

    def test_execution_result_multiple_tools(self):
        """Test ExecutionResult tracking multiple tools."""
        tools = ["search", "read", "analyze", "write", "commit"]
        result = ExecutionResult(
            task_id="task-004",
            success=True,
            output="Complete",
            error=None,
            duration_seconds=120.0,
            tools_used=tools,
            tokens_consumed=5000
        )

        assert len(result.tools_used) == 5
        assert result.tools_used == tools


class TestOrchestratorConfig:
    """Test OrchestratorConfig entity structure and behavior."""

    def test_orchestrator_config_default_values(self):
        """Test OrchestratorConfig with default values."""
        config = OrchestratorConfig()

        assert config.execution_mode == ExecutionMode.AUTONOMOUS
        assert config.max_iterations == 100
        assert config.health_check_interval == 10
        assert config.auto_checkpoint is True
        assert config.checkpoint_interval == 20
        assert config.recovery_enabled is True
        assert config.escalation_enabled is True

    def test_orchestrator_config_custom_values(self):
        """Test OrchestratorConfig with custom values."""
        config = OrchestratorConfig(
            execution_mode=ExecutionMode.SUPERVISED,
            max_iterations=50,
            health_check_interval=5,
            auto_checkpoint=False,
            checkpoint_interval=10,
            recovery_enabled=False,
            escalation_enabled=False
        )

        assert config.execution_mode == ExecutionMode.SUPERVISED
        assert config.max_iterations == 50
        assert config.health_check_interval == 5
        assert config.auto_checkpoint is False
        assert config.checkpoint_interval == 10
        assert config.recovery_enabled is False
        assert config.escalation_enabled is False

    def test_orchestrator_config_interactive_mode(self):
        """Test OrchestratorConfig with interactive mode."""
        config = OrchestratorConfig(
            execution_mode=ExecutionMode.INTERACTIVE,
            max_iterations=10
        )

        assert config.execution_mode == ExecutionMode.INTERACTIVE

    def test_orchestrator_config_all_modes_supported(self):
        """Test that all execution modes are supported in config."""
        for mode in ExecutionMode:
            config = OrchestratorConfig(execution_mode=mode)
            assert config.execution_mode == mode
