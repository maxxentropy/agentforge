# Generated by AgentForge
# Spec: recovery_strategies
# Phase: red
# Date: 2025-12-31 06:44:38 UTC

"""
Tests for recovery domain entities.
These tests verify the structure and behavior of recovery domain objects
including enums, data classes, and their validation logic.
"""

import pytest
from datetime import datetime
from typing import Optional

from tools.harness.recovery_domain import (
    RecoveryAction,
    RecoveryResult,
    Checkpoint,
    RecoveryAttempt,
    RecoveryPolicy
)


class TestRecoveryAction:
    """Test RecoveryAction enum values and behavior."""
    
    def test_recovery_action_has_all_required_values(self):
        """Test that RecoveryAction enum contains all specified values."""
        expected_values = {
            'CHECKPOINT',
            'ROLLBACK', 
            'SUMMARIZE',
            'RESET',
            'ESCALATE',
            'RETRY',
            'SKIP'
        }
        actual_values = {action.name for action in RecoveryAction}
        assert actual_values == expected_values
    
    def test_recovery_action_values_are_accessible(self):
        """Test that individual RecoveryAction values can be accessed."""
        assert RecoveryAction.CHECKPOINT
        assert RecoveryAction.ROLLBACK
        assert RecoveryAction.SUMMARIZE
        assert RecoveryAction.RESET
        assert RecoveryAction.ESCALATE
        assert RecoveryAction.RETRY
        assert RecoveryAction.SKIP


class TestRecoveryResult:
    """Test RecoveryResult enum values and behavior."""
    
    def test_recovery_result_has_all_required_values(self):
        """Test that RecoveryResult enum contains all specified values."""
        expected_values = {
            'SUCCESS',
            'PARTIAL',
            'FAILED', 
            'SKIPPED'
        }
        actual_values = {result.name for result in RecoveryResult}
        assert actual_values == expected_values
    
    def test_recovery_result_values_are_accessible(self):
        """Test that individual RecoveryResult values can be accessed."""
        assert RecoveryResult.SUCCESS
        assert RecoveryResult.PARTIAL
        assert RecoveryResult.FAILED
        assert RecoveryResult.SKIPPED


class TestCheckpoint:
    """Test Checkpoint entity structure and behavior."""
    
    def test_checkpoint_creation_with_required_fields(self):
        """Test creating a Checkpoint with all required fields."""
        timestamp = datetime.now()
        checkpoint = Checkpoint(
            id="test-checkpoint-1",
            timestamp=timestamp,
            session_id="session-123",
            phase="planning",
            state={"key": "value"},
            file_backups=["/path/to/backup1.txt", "/path/to/backup2.txt"]
        )
        
        assert checkpoint.id == "test-checkpoint-1"
        assert checkpoint.timestamp == timestamp
        assert checkpoint.session_id == "session-123"
        assert checkpoint.phase == "planning"
        assert checkpoint.state == {"key": "value"}
        assert checkpoint.file_backups == ["/path/to/backup1.txt", "/path/to/backup2.txt"]
        assert checkpoint.description is None
    
    def test_checkpoint_creation_with_optional_description(self):
        """Test creating a Checkpoint with optional description field."""
        checkpoint = Checkpoint(
            id="test-checkpoint-2",
            timestamp=datetime.now(),
            session_id="session-456",
            phase="execution",
            state={},
            file_backups=[],
            description="Before risky operation"
        )
        
        assert checkpoint.description == "Before risky operation"
    
    def test_checkpoint_state_can_be_complex_dict(self):
        """Test that Checkpoint state field can hold complex nested data."""
        complex_state = {
            "variables": {"x": 1, "y": 2},
            "context": ["item1", "item2"],
            "nested": {"deep": {"value": True}}
        }
        
        checkpoint = Checkpoint(
            id="complex-checkpoint",
            timestamp=datetime.now(),
            session_id="session-789",
            phase="analysis",
            state=complex_state,
            file_backups=[]
        )
        
        assert checkpoint.state == complex_state
    
    def test_checkpoint_file_backups_can_be_empty_list(self):
        """Test that Checkpoint can have empty file_backups list."""
        checkpoint = Checkpoint(
            id="no-files-checkpoint",
            timestamp=datetime.now(),
            session_id="session-empty",
            phase="start",
            state={},
            file_backups=[]
        )
        
        assert checkpoint.file_backups == []


class TestRecoveryAttempt:
    """Test RecoveryAttempt entity structure and behavior."""
    
    def test_recovery_attempt_creation_with_required_fields(self):
        """Test creating a RecoveryAttempt with required fields."""
        timestamp = datetime.now()
        attempt = RecoveryAttempt(
            action=RecoveryAction.CHECKPOINT,
            timestamp=timestamp,
            trigger="loop detected",
            result=RecoveryResult.SUCCESS
        )
        
        assert attempt.action == RecoveryAction.CHECKPOINT
        assert attempt.timestamp == timestamp
        assert attempt.trigger == "loop detected"
        assert attempt.result == RecoveryResult.SUCCESS
        assert attempt.details is None
        assert attempt.error is None
    
    def test_recovery_attempt_creation_with_optional_fields(self):
        """Test creating a RecoveryAttempt with optional details and error."""
        attempt = RecoveryAttempt(
            action=RecoveryAction.ROLLBACK,
            timestamp=datetime.now(),
            trigger="drift detected",
            result=RecoveryResult.FAILED,
            details={"checkpoint_id": "cp-123", "files_restored": 3},
            error="Failed to restore file: permission denied"
        )
        
        assert attempt.details == {"checkpoint_id": "cp-123", "files_restored": 3}
        assert attempt.error == "Failed to restore file: permission denied"
    
    def test_recovery_attempt_supports_all_action_types(self):
        """Test that RecoveryAttempt can be created with all RecoveryAction types."""
        for action in RecoveryAction:
            attempt = RecoveryAttempt(
                action=action,
                timestamp=datetime.now(),
                trigger="test trigger",
                result=RecoveryResult.SUCCESS
            )
            assert attempt.action == action
    
    def test_recovery_attempt_supports_all_result_types(self):
        """Test that RecoveryAttempt can be created with all RecoveryResult types."""
        for result in RecoveryResult:
            attempt = RecoveryAttempt(
                action=RecoveryAction.RETRY,
                timestamp=datetime.now(),
                trigger="test trigger",
                result=result
            )
            assert attempt.result == result


class TestRecoveryPolicy:
    """Test RecoveryPolicy entity structure and behavior."""
    
    def test_recovery_policy_creation_with_required_fields(self):
        """Test creating a RecoveryPolicy with required fields."""
        policy = RecoveryPolicy(
            name="test_policy",
            triggers=["loop", "drift"],
            actions=[RecoveryAction.CHECKPOINT, RecoveryAction.ROLLBACK]
        )
        
        assert policy.name == "test_policy"
        assert policy.triggers == ["loop", "drift"]
        assert policy.actions == [RecoveryAction.CHECKPOINT, RecoveryAction.ROLLBACK]
        assert policy.max_attempts == 3  # default value
        assert policy.cooldown_seconds == 60  # default value
    
    def test_recovery_policy_creation_with_custom_defaults(self):
        """Test creating a RecoveryPolicy with custom max_attempts and cooldown."""
        policy = RecoveryPolicy(
            name="custom_policy",
            triggers=["thrashing"],
            actions=[RecoveryAction.RESET],
            max_attempts=5,
            cooldown_seconds=120
        )
        
        assert policy.max_attempts == 5
        assert policy.cooldown_seconds == 120
    
    def test_recovery_policy_supports_multiple_triggers(self):
        """Test that RecoveryPolicy can handle multiple trigger conditions."""
        triggers = [
            "loop detected",
            "Loop detected", 
            "Repeated action",
            "circular behavior"
        ]
        
        policy = RecoveryPolicy(
            name="multi_trigger_policy",
            triggers=triggers,
            actions=[RecoveryAction.CHECKPOINT]
        )
        
        assert policy.triggers == triggers
    
    def test_recovery_policy_supports_multiple_actions(self):
        """Test that RecoveryPolicy can handle multiple recovery actions."""
        actions = [
            RecoveryAction.CHECKPOINT,
            RecoveryAction.SUMMARIZE,
            RecoveryAction.ROLLBACK,
            RecoveryAction.ESCALATE
        ]
        
        policy = RecoveryPolicy(
            name="multi_action_policy",
            triggers=["complex issue"],
            actions=actions
        )
        
        assert policy.actions == actions
    
    def test_recovery_policy_empty_triggers_list(self):
        """Test that RecoveryPolicy can be created with empty triggers list."""
        policy = RecoveryPolicy(
            name="no_triggers_policy",
            triggers=[],
            actions=[RecoveryAction.ESCALATE]
        )
        
        assert policy.triggers == []
    
    def test_recovery_policy_single_action(self):
        """Test that RecoveryPolicy can be created with single action."""
        policy = RecoveryPolicy(
            name="single_action_policy",
            triggers=["critical error"],
            actions=[RecoveryAction.ESCALATE]
        )
        
        assert len(policy.actions) == 1
        assert policy.actions[0] == RecoveryAction.ESCALATE
    
    def test_recovery_policy_max_attempts_custom_value(self):
        """Test that RecoveryPolicy accepts custom max_attempts value."""
        policy = RecoveryPolicy(
            name="valid_policy",
            triggers=["test"],
            actions=[RecoveryAction.RETRY],
            max_attempts=1
        )
        assert policy.max_attempts == 1

        # Zero attempts is technically allowed (caller's responsibility)
        policy_zero = RecoveryPolicy(
            name="zero_policy",
            triggers=["test"],
            actions=[RecoveryAction.RETRY],
            max_attempts=0
        )
        assert policy_zero.max_attempts == 0

    def test_recovery_policy_cooldown_custom_value(self):
        """Test that RecoveryPolicy accepts custom cooldown_seconds value."""
        policy = RecoveryPolicy(
            name="valid_policy",
            triggers=["test"],
            actions=[RecoveryAction.RETRY],
            cooldown_seconds=0
        )
        assert policy.cooldown_seconds == 0

        # Large cooldown
        policy_large = RecoveryPolicy(
            name="large_cooldown_policy",
            triggers=["test"],
            actions=[RecoveryAction.RETRY],
            cooldown_seconds=3600
        )
        assert policy_large.cooldown_seconds == 3600
