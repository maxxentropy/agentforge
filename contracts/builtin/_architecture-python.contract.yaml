schema_version: "1.0"

contract:
  name: "_architecture-python"
  type: architecture
  description: |
    Python Clean Architecture enforcement using semantic analysis.
    Detects layer violations through AST-based import inspection.

    Replaces regex-based checks with semantic AST analysis for:
    - Accurate import detection (no false positives from strings/comments)
    - Detection of aliased imports
    - Support for both `import x` and `from x import y` forms
  version: "2.0.0"
  enabled: true
  extends: "_patterns-python"
  applies_to:
    languages:
      - python
    repo_types:
      - service
      - api
  tags:
    - builtin
    - python
    - architecture
    - clean-architecture

checks:
  # ===========================================================================
  # Clean Architecture Layer Enforcement (Semantic Analysis)
  # ===========================================================================

  - id: layer-dependency-violations
    name: "Clean Architecture Layer Violations"
    description: |
      Enforces dependency direction in Clean Architecture:
      - Domain layer: No dependencies on other layers
      - Application layer: May depend on Domain only
      - Infrastructure layer: May depend on Domain and Application
      - Presentation layer: May depend on Application only
    type: custom
    severity: error
    config:
      module: builtin_checks
      function: layer_imports
      params:
        layer_detection:
          "**/domain/**": "domain"
          "**/core/**": "domain"
          "**/entities/**": "domain"
          "**/application/**": "application"
          "**/use_cases/**": "application"
          "**/services/**": "application"
          "**/infrastructure/**": "infrastructure"
          "**/adapters/**": "infrastructure"
          "**/repositories/**": "infrastructure"
          "**/presentation/**": "presentation"
          "**/api/**": "presentation"
          "**/cli/**": "presentation"
          "**/web/**": "presentation"
        layer_rules:
          domain:
            forbidden:
              - infrastructure
              - application
              - presentation
              - adapters
              - repositories
              - api
              - cli
              - web
            message: "Domain layer must have no external dependencies"
          application:
            forbidden:
              - infrastructure
              - presentation
              - adapters
              - repositories
              - api
              - cli
              - web
            allowed:
              - domain
              - core
              - entities
            message: "Application layer may only depend on Domain"
          infrastructure:
            forbidden:
              - presentation
              - api
              - cli
              - web
            allowed:
              - domain
              - application
              - core
              - entities
            message: "Infrastructure may depend on Domain and Application"
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"
        - "**/__init__.py"
        - "**/conftest.py"
    fix_hint: |
      Move the import to the appropriate layer or use dependency injection.
      Domain should never import from infrastructure - inject interfaces instead.

  # ===========================================================================
  # Domain Layer Purity
  # ===========================================================================

  - id: domain-purity
    name: "Domain Layer Purity"
    description: |
      Domain layer should contain only pure business logic - no I/O operations,
      HTTP calls, database access, or filesystem operations.
    type: custom
    severity: error
    config:
      module: builtin_checks
      function: domain_purity
      params:
        forbidden_imports:
          - requests
          - httpx
          - aiohttp
          - urllib.request
          - sqlite3
          - psycopg2
          - pymongo
          - redis
          - sqlalchemy
          - django.db
          - flask_sqlalchemy
          - boto3
          - azure
          - google.cloud
        forbidden_calls:
          - "open("
          - "Path.read"
          - "Path.write"
          - "os.path"
          - "shutil."
          - "subprocess."
          - "os.system("
          - "os.popen("
    applies_to:
      paths:
        - "**/domain/**/*.py"
        - "**/core/**/*.py"
        - "**/entities/**/*.py"
      exclude_paths:
        - "**/tests/**"
    fix_hint: "Move I/O operations to infrastructure layer; domain should be pure business logic"

  # ===========================================================================
  # Dependency Injection Pattern Detection
  # ===========================================================================

  - id: constructor-injection-required
    name: "Constructor Injection Required"
    description: |
      Service classes should receive dependencies through constructor injection,
      not instantiate them directly.
    type: custom
    severity: warning
    config:
      module: builtin_checks
      function: constructor_injection
      params:
        class_patterns:
          - "*Service"
          - "*Repository"
          - "*Handler"
          - "*UseCase"
          - "*Manager"
        forbidden_instantiations:
          - "HttpClient("
          - "SqlConnection("
          - "requests.Session("
          - "aiohttp.ClientSession("
        check_for_init_params: true
    applies_to:
      paths:
        - "**/application/**/*.py"
        - "**/services/**/*.py"
        - "**/use_cases/**/*.py"
      exclude_paths:
        - "**/tests/**"
    fix_hint: "Inject dependencies through __init__ parameters instead of instantiating directly"

  # ===========================================================================
  # Circular Import Prevention
  # ===========================================================================

  - id: no-circular-imports
    name: "No Circular Imports"
    description: "Modules should not have circular import dependencies"
    type: custom
    severity: error
    config:
      module: builtin_checks
      function: circular_imports
      params:
        ignore_type_checking: true  # Allow TYPE_CHECKING imports
        max_depth: 5
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"
    fix_hint: |
      Break circular imports by:
      1. Moving shared types to a separate module
      2. Using TYPE_CHECKING guards for type hints
      3. Restructuring dependencies to flow in one direction

  # ===========================================================================
  # Structure Checks
  # ===========================================================================

  - id: require-init-files
    name: "Package __init__.py Required"
    description: "Python packages must have __init__.py files"
    type: file_exists
    severity: warning
    config:
      required_files:
        - "src/**/__init__.py"
    fix_hint: "Create __init__.py in each package directory"

  - id: single-responsibility-modules
    name: "Single Responsibility Modules"
    description: "Modules should focus on a single responsibility"
    type: ast_check
    severity: info
    config:
      metric: class_size
      threshold: 3
      scope: file
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"
        - "**/__init__.py"
    fix_hint: "Split modules with too many classes into focused single-class modules"

  # ===========================================================================
  # Pattern Enforcement
  # ===========================================================================

  - id: no-god-classes
    name: "No God Classes"
    description: "Classes should not have excessive responsibilities"
    type: ast_check
    severity: warning
    config:
      metric: class_size
      threshold: 15
      scope: class
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"
    fix_hint: "Split large classes using composition or inheritance"

  - id: repository-pattern
    name: "Repository Pattern Required"
    description: "Data access should use repository pattern"
    type: file_exists
    severity: info
    enabled: false  # Enable per-repo
    config:
      required_files:
        - "**/repositories/*.py"
        - "**/interfaces/repositories.py"
    fix_hint: "Create repository interfaces and implementations for data access"
