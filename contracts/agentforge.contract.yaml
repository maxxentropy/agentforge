schema_version: "1.0"

contract:
  name: "agentforge"
  type: patterns
  description: |
    AgentForge project contract with production-ready defaults.

    This contract enables meaningful checks by default while allowing
    customization based on tooling and workflow needs.

    Tier 1: Always enabled (errors) - Architecture, security
    Tier 2: Enabled by default (warnings) - Code quality
    Tier 3: Tool-dependent (disabled) - External tools
  version: "2.1.0"
  enabled: true
  extends:
    # Builtin base contracts
    - "_architecture-python"
    - "_patterns-python"
    - "_typing-python"
    - "_security-python"
    - "_testing-python"
    - "_cli-python"
    # AgentForge-specific contracts (names match contract.name field)
    - "agentforge-lineage"
    - "agentforge-specs"
    - "agentforge-structure"
  applies_to:
    languages:
      - python
    # Only check files that participate in the build
    paths:
      - "src/agentforge/**/*.py"
      - "tests/**/*.py"
      - ".agentforge/specs/**/*.yaml"
      - "contracts/**/*.yaml"
    exclude_paths:
      - "**/__pycache__/**"
      - "**/*.egg-info/**"
      - ".git/**"
      - ".agentforge/violations/**"
      - ".agentforge/bridge/**"
      - "docs/**/*.md"
      - "*.md"
  tags:
    - agentforge
    - python
    - production

checks:
  # ===========================================================================
  # TIER 1: ALWAYS ENABLED - Errors
  # ===========================================================================

  # Architecture checks - ENABLED (custom functions implemented)
  - id: layer-dependency-violations
    enabled: true
    severity: error

  - id: domain-purity
    enabled: true
    severity: error

  - id: no-circular-imports
    enabled: true
    severity: error

  # Security checks - ENABLED
  # Override no-secrets-in-code with a more precise pattern that avoids false positives
  # The pattern specifically looks for quoted key names followed by quoted values
  - id: no-secrets-in-code
    name: "No Hardcoded Secrets"
    description: "Passwords and API keys should not be hardcoded"
    type: regex
    severity: error
    enabled: true
    config:
      # Pattern matches: "api_key" = "secret" or 'secret_key': 'value'
      # but NOT: ENV_API_KEY = "VARIABLE_NAME" (env var name definitions)
      # Requires the key to be quoted OR to start with lowercase (no UPPER_CASE prefixes)
      pattern: "['\"](?:password|api_key|apikey|secret|token)['\"]\\s*[=:]\\s*['\"][^'\"]{8,}['\"]"
      mode: forbid
      case_insensitive: true
    applies_to:
      paths:
        - "src/agentforge/**/*.py"
      exclude_paths:
        - "**/tests/**"
        - ".agentforge/**"
    fix_hint: "Use environment variables or a secrets manager"

  - id: no-private-keys
    enabled: true
    severity: error

  - id: no-env-files
    enabled: false  # Disabled - .env is gitignored, checking working dir is noisy
    severity: error

  - id: no-env-files-committed
    enabled: false  # Disabled - .env is gitignored, checking working dir is noisy
    severity: error

  # Override hardcoded API key check to exclude:
  # 1. Placeholder patterns like "sk-ant-..."
  # 2. Environment variable name definitions like ENV_API_KEY = "ANTHROPIC_API_KEY"
  - id: no-hardcoded-api-keys
    name: "No Hardcoded API Keys"
    description: "API keys should not be hardcoded (excludes placeholders and env var names)"
    type: regex
    severity: error
    config:
      # Pattern matches: "api_key" = "secret" (quoted key name)
      # Does NOT match: ENV_API_KEY = "..." (var name with _API_KEY suffix)
      pattern: "['\"](?:api_key|apikey|api-key|secret_key)['\"]\\s*[=:]\\s*['\"][^'\"]{8,}['\"]"
      mode: forbid
      case_insensitive: true
    applies_to:
      paths:
        - "src/agentforge/**/*.py"
      exclude_paths:
        - "**/tests/**"
        - ".agentforge/**"
    fix_hint: "Use environment variables: os.environ.get('API_KEY')"

  # Project-specific security
  - id: yaml-safe-load
    name: "Use yaml.safe_load"
    description: "Always use safe_load for YAML parsing"
    type: regex
    severity: error
    enabled: true
    config:
      pattern: "yaml\\.load\\s*\\([^)]*\\)(?!.*Loader)"
      mode: forbid
    applies_to:
      paths:
        - "**/*.py"
    fix_hint: "Use yaml.safe_load() instead of yaml.load()"

  # ===========================================================================
  # TIER 2: ENABLED BY DEFAULT - Warnings
  # ===========================================================================

  # Code quality metrics - ENABLED as warnings (relaxed for tests)
  - id: max-cyclomatic-complexity
    enabled: true
    severity: warning
    config:
      metric: cyclomatic_complexity
      threshold: 10
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"

  - id: max-function-length
    enabled: true
    severity: warning
    config:
      metric: function_length
      threshold: 50
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"

  - id: max-nesting-depth
    enabled: true
    severity: warning
    config:
      metric: nesting_depth
      threshold: 4
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"

  # CLI commands naturally have many parameters due to Click decorators
  - id: max-parameter-count
    enabled: true
    severity: warning
    config:
      metric: parameter_count
      threshold: 5
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/cli/click_commands/**"
        - "**/cli/commands/**"
        - "**/cli/main.py"
        - "**/tests/**"

  - id: max-class-size
    enabled: true
    severity: warning
    config:
      metric: class_size
      threshold: 20
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"

  # Pattern checks - ENABLED
  - id: no-bare-except
    enabled: true
    severity: warning

  - id: no-star-imports
    enabled: true
    severity: warning

  - id: no-breakpoint
    enabled: true
    severity: error

  - id: no-pdb-import
    enabled: true
    severity: error

  # DI pattern - DISABLED (check override doesn't merge type from parent)
  - id: constructor-injection-required
    type: custom  # DI pattern check - disabled
    enabled: false  # Inheritance issue - disabled until fixed
    severity: warning

  # File structure - ENABLED
  # NOTE: Structure checks are now handled by agentforge/structure contract
  - id: require-tools-init
    type: file_exists  # Legacy check - disabled
    enabled: false  # Legacy - code is now in src/agentforge/

  - id: require-schemas-dir
    type: file_exists  # Legacy check - disabled
    enabled: false  # Handled by agentforge/structure contract

  - id: require-builtin-contracts
    name: "Builtin Contracts Required"
    description: "Project should have builtin contract definitions"
    type: file_exists
    severity: warning
    enabled: true
    config:
      required_files:
        - "contracts/builtin/_base.contract.yaml"
    fix_hint: "Create builtin contract files in contracts/builtin/"

  - id: max-file-lines
    name: "Maximum File Lines"
    description: "Files should not exceed maximum line count"
    type: custom
    severity: warning
    enabled: true
    config:
      module: builtin_checks
      function: check_file_size
      params:
        max_lines: 500
        max_bytes: 100000
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "tests/**"
        - "**/test_*.py"
    fix_hint: "Split large files into smaller modules"

  # Contract validation - ENABLED
  - id: contract-schema-version
    name: "Contracts Have Schema Version"
    description: "All contract files must specify schema_version"
    type: regex
    severity: error
    enabled: true
    config:
      pattern: "^schema_version:\\s*['\"]?[12]\\.0['\"]?"
      mode: require
      multiline: true  # Match start of any line, not just file start
    applies_to:
      paths:
        - "contracts/**/*.contract.yaml"
    fix_hint: "Add 'schema_version: \"1.0\"' or '\"2.0\"' at the top of the contract file"

  - id: contract-has-name
    name: "Contracts Have Name"
    description: "All contracts must have a name field"
    type: regex
    severity: error
    enabled: true
    config:
      pattern: "contract:\\s*\\n\\s+name:"
      mode: require
      multiline: true
    applies_to:
      paths:
        - "contracts/**/*.contract.yaml"
    fix_hint: "Add 'name' field to contract definition"

  # Code quality rules - ENABLED
  - id: no-hardcoded-paths
    name: "No Hardcoded Absolute Paths"
    description: "Use Path objects and relative paths"
    type: regex
    severity: warning
    enabled: true
    config:
      pattern: "['\"]/(Users|home|opt|var)/"
      mode: forbid
    applies_to:
      paths:
        - "src/agentforge/**/*.py"
      exclude_paths:
        - "**/tests/**"
    fix_hint: "Use Path objects and relative paths from repo root"

  - id: use-pathlib
    name: "Use pathlib for Path Operations"
    description: "Use pathlib.Path instead of os.path"
    type: regex
    severity: info
    enabled: true
    config:
      pattern: "os\\.path\\.(join|exists|isfile|isdir|dirname|basename)"
      mode: forbid
    applies_to:
      paths:
        - "src/agentforge/**/*.py"
    fix_hint: "Use pathlib.Path: path.exists(), path.is_file(), path / 'subdir'"

  # ===========================================================================
  # LINEAGE AUDIT TRAIL - Enforces traceability
  # ===========================================================================
  # NOTE: Lineage checks are now handled by agentforge/lineage contract

  # ===========================================================================
  # TIER 3: TOOL-DEPENDENT - Disabled until tools available
  # ===========================================================================

  # These check for tool availability before running
  - id: ruff-lint
    name: "Ruff Linting"
    type: command
    severity: warning
    enabled: false  # Enable with: pip install ruff
    config:
      command: "ruff"
      args: ["check", "."]
      prerequisite: "which ruff"

  - id: ruff-format
    name: "Ruff Formatting"
    type: command
    severity: info
    enabled: false
    config:
      command: "ruff"
      args: ["format", "--check", "."]
      prerequisite: "which ruff"

  - id: mypy-standard
    name: "mypy Type Check"
    type: command
    severity: warning
    enabled: false  # Enable with: pip install mypy
    config:
      command: "mypy"
      args: [".", "--ignore-missing-imports"]
      prerequisite: "which mypy"

  - id: pytest-pass
    name: "pytest Tests Pass"
    type: command
    severity: error
    enabled: false  # Enable when tests exist
    config:
      command: "pytest"
      args: ["tests/", "-v", "--tb=short"]
      prerequisite: "test -d tests"

  - id: bandit-scan
    name: "Bandit Security Scan"
    type: command
    severity: warning
    enabled: false
    config:
      command: "bandit"
      args: ["-r", ".", "-ll"]
      prerequisite: "which bandit"

  # ===========================================================================
  # OVERRIDES - Project-specific adjustments
  # ===========================================================================

  # CLI uses click.echo() for output - disable print check
  - id: no-print-statements
    enabled: false  # Legacy - CLI now uses click.echo()

  # Click patterns only apply to CLI definition files, not handler implementations
  # Override to match both @click.command and @group.command patterns
  # Exclude main.py (only has @click.group which gets help from docstring)
  - id: commands-have-help
    config:
      pattern: "@\\w+\\.command\\s*\\([^)]*help\\s*="
      mode: require
    applies_to:
      paths:
        - "cli/click_commands/*.py"
      exclude_paths:
        - "cli/click_commands/__init__.py"

  # Only check path validation in files that actually have path arguments
  - id: path-inputs-validated
    applies_to:
      paths:
        - "cli/click_commands/spec.py"
        - "cli/click_commands/utility.py"
        - "cli/click_commands/workspace.py"

  - id: validate-cli-inputs
    applies_to:
      paths:
        - "cli/main.py"
        - "cli/click_commands/*.py"
      exclude_paths:
        - "cli/click_commands/__init__.py"

  - id: options-have-help
    applies_to:
      paths:
        - "cli/main.py"
        - "cli/click_commands/*.py"
      exclude_paths:
        - "cli/click_commands/__init__.py"

  # Minimal Context Architecture validation
  - id: minimal-context-validation
    name: "Minimal Context Validation Methods"
    description: "Ensure runtime validation methods exist in context architecture"
    type: custom
    severity: error
    enabled: true
    config:
      module: builtin_checks
      function: check_minimal_context_validation
    applies_to:
      paths:
        - "src/agentforge/core/harness/minimal_context/*.py"
    fix_hint: "Add required validation methods for runtime integrity checking"

  # Architecture checks relaxed for tests
  - id: no-god-classes
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "tests/**"
        - "**/test_*.py"

  - id: no-http-without-https
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "tests/**"
        - "**/test_*.py"

  # Project uses tools/ not src/ layout
  - id: require-init-files
    enabled: false  # Non-standard layout

  # execute.py is the entry point
  - id: require-main-entry
    enabled: false  # Using execute.py instead

  # Disable test directory checks (tests now exist)
  - id: require-tests-directory
    enabled: false  # Tests exist but in different structure

  - id: require-conftest
    enabled: false  # conftest.py exists in tests/
