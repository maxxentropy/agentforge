# @spec_file: .agentforge/specs/core-harness-v1.yaml
# @spec_id: core-harness-v1
# @component_id: tools-harness-escalation_notifier
# @impl_path: tools/harness/escalation_notifier.py

# Generated by AgentForge
# Spec: human_escalation
# Phase: red
# Date: 2025-12-31

"""
Tests for EscalationNotifier - sends notifications through configured channels.
These tests verify notification formatting and delivery across CLI, file, and webhook channels.
"""

import json
import tempfile
from datetime import datetime
from pathlib import Path
from unittest.mock import Mock, patch

import pytest

from agentforge.core.harness.escalation_domain import (
    Escalation,
    EscalationChannel,
    EscalationPriority,
    EscalationStatus,
)
from agentforge.core.harness.escalation_notifier import EscalationNotifier


class TestEscalationNotifierInit:
    """Test EscalationNotifier initialization."""

    def test_init_with_channels_creates_notifier(self):
        """Test that EscalationNotifier can be initialized with channels."""
        channels = [EscalationChannel.CLI, EscalationChannel.FILE]
        notifier = EscalationNotifier(channels=channels)

        assert notifier is not None
        assert notifier.channels == channels

    def test_init_with_config_sets_configuration(self):
        """Test that EscalationNotifier accepts configuration."""
        config = {"webhook_url": "https://example.com/hook"}
        notifier = EscalationNotifier(
            channels=[EscalationChannel.WEBHOOK],
            config=config
        )

        assert notifier.config == config

    def test_init_with_empty_channels_allowed(self):
        """Test that notifier can be created with no channels."""
        notifier = EscalationNotifier(channels=[])

        assert notifier.channels == []


class TestNotify:
    """Test main notification functionality."""

    @pytest.fixture
    def sample_escalation(self):
        """Create a sample escalation for testing."""
        return Escalation(
            id="esc-001",
            session_id="session-123",
            created_at=datetime.now(),
            priority=EscalationPriority.HIGH,
            status=EscalationStatus.PENDING,
            reason="Test escalation",
            context={"key": "value"},
            recommended_actions=["Action 1", "Action 2"]
        )

    def test_notify_returns_results_dict(self, sample_escalation):
        """Test that notify returns dict mapping channel to success."""
        notifier = EscalationNotifier(channels=[EscalationChannel.CLI])

        with patch.object(notifier, 'notify_cli', return_value=True):
            results = notifier.notify(sample_escalation)

        assert isinstance(results, dict)
        assert EscalationChannel.CLI in results

    def test_notify_attempts_all_channels(self, sample_escalation):
        """Test that notify attempts all configured channels."""
        channels = [EscalationChannel.CLI, EscalationChannel.FILE]
        notifier = EscalationNotifier(channels=channels)

        with patch.object(notifier, 'notify_cli', return_value=True), \
             patch.object(notifier, 'notify_file', return_value=True):
            results = notifier.notify(sample_escalation)

        assert len(results) == 2

    def test_notify_handles_channel_failure(self, sample_escalation):
        """Test that notify continues after channel failure."""
        channels = [EscalationChannel.CLI, EscalationChannel.FILE]
        notifier = EscalationNotifier(channels=channels)

        with patch.object(notifier, 'notify_cli', return_value=False), \
             patch.object(notifier, 'notify_file', return_value=True):
            results = notifier.notify(sample_escalation)

        assert results[EscalationChannel.CLI] is False
        assert results[EscalationChannel.FILE] is True


class TestNotifyCli:
    """Test CLI notification functionality."""

    @pytest.fixture
    def sample_escalation(self):
        """Create a sample escalation for testing."""
        return Escalation(
            id="esc-cli-001",
            session_id="session-123",
            created_at=datetime.now(),
            priority=EscalationPriority.CRITICAL,
            status=EscalationStatus.PENDING,
            reason="Critical error",
            context={},
            recommended_actions=["Check logs"]
        )

    def test_notify_cli_returns_true_on_success(self, sample_escalation):
        """Test that CLI notification returns True on success."""
        notifier = EscalationNotifier(channels=[EscalationChannel.CLI])

        with patch('builtins.print'):
            result = notifier.notify_cli(sample_escalation)

        assert result is True

    def test_notify_cli_prints_escalation_info(self, sample_escalation):
        """Test that CLI notification prints escalation details."""
        notifier = EscalationNotifier(channels=[EscalationChannel.CLI])

        with patch('builtins.print') as mock_print:
            notifier.notify_cli(sample_escalation)

        # Check that print was called with some escalation content
        mock_print.assert_called()
        call_args_str = str(mock_print.call_args_list)
        assert "esc-cli-001" in call_args_str or "Critical" in call_args_str or "CRITICAL" in call_args_str

    def test_notify_cli_includes_priority(self, sample_escalation):
        """Test that CLI notification includes priority level."""
        notifier = EscalationNotifier(channels=[EscalationChannel.CLI])

        with patch('builtins.print') as mock_print:
            notifier.notify_cli(sample_escalation)

        # Should mention priority somewhere
        all_output = " ".join(str(c) for c in mock_print.call_args_list)
        assert "CRITICAL" in all_output.upper()


class TestNotifyFile:
    """Test file notification functionality."""

    @pytest.fixture
    def sample_escalation(self):
        """Create a sample escalation for testing."""
        return Escalation(
            id="esc-file-001",
            session_id="session-123",
            created_at=datetime.now(),
            priority=EscalationPriority.HIGH,
            status=EscalationStatus.PENDING,
            reason="File test",
            context={"data": "test"},
            recommended_actions=[]
        )

    def test_notify_file_returns_true_on_success(self, sample_escalation):
        """Test that file notification returns True on success."""
        with tempfile.TemporaryDirectory() as temp_dir:
            file_path = Path(temp_dir) / "escalation.json"
            notifier = EscalationNotifier(channels=[EscalationChannel.FILE])

            result = notifier.notify_file(sample_escalation, file_path=file_path)

            assert result is True

    def test_notify_file_creates_file(self, sample_escalation):
        """Test that file notification creates file."""
        with tempfile.TemporaryDirectory() as temp_dir:
            file_path = Path(temp_dir) / "escalation.json"
            notifier = EscalationNotifier(channels=[EscalationChannel.FILE])

            notifier.notify_file(sample_escalation, file_path=file_path)

            assert file_path.exists()

    def test_notify_file_writes_valid_json(self, sample_escalation):
        """Test that file contains valid JSON."""
        with tempfile.TemporaryDirectory() as temp_dir:
            file_path = Path(temp_dir) / "escalation.json"
            notifier = EscalationNotifier(channels=[EscalationChannel.FILE])

            notifier.notify_file(sample_escalation, file_path=file_path)

            with open(file_path) as f:
                data = json.load(f)

            assert data["id"] == "esc-file-001"
            assert data["reason"] == "File test"

    def test_notify_file_uses_default_path_when_none(self, sample_escalation):
        """Test that file uses default path when not specified."""
        with tempfile.TemporaryDirectory() as temp_dir:
            notifier = EscalationNotifier(
                channels=[EscalationChannel.FILE],
                config={"file_path_base": temp_dir}
            )

            result = notifier.notify_file(sample_escalation)

            # Should succeed even without explicit path
            assert result is True


class TestNotifyWebhook:
    """Test webhook notification functionality."""

    @pytest.fixture
    def sample_escalation(self):
        """Create a sample escalation for testing."""
        return Escalation(
            id="esc-webhook-001",
            session_id="session-123",
            created_at=datetime.now(),
            priority=EscalationPriority.MEDIUM,
            status=EscalationStatus.PENDING,
            reason="Webhook test",
            context={},
            recommended_actions=[]
        )

    def test_notify_webhook_returns_true_on_success(self, sample_escalation):
        """Test that webhook notification returns True on success."""
        notifier = EscalationNotifier(
            channels=[EscalationChannel.WEBHOOK],
            config={"webhook_url": "https://example.com/hook"}
        )

        with patch('requests.post') as mock_post:
            mock_post.return_value = Mock(status_code=200)
            result = notifier.notify_webhook(
                sample_escalation,
                webhook_url="https://example.com/hook"
            )

        assert result is True

    def test_notify_webhook_posts_to_url(self, sample_escalation):
        """Test that webhook POSTs to the correct URL."""
        notifier = EscalationNotifier(channels=[EscalationChannel.WEBHOOK])
        url = "https://example.com/webhook"

        with patch('requests.post') as mock_post:
            mock_post.return_value = Mock(status_code=200)
            notifier.notify_webhook(sample_escalation, webhook_url=url)

        mock_post.assert_called_once()
        call_args = mock_post.call_args
        assert call_args[0][0] == url

    def test_notify_webhook_returns_false_on_failure(self, sample_escalation):
        """Test that webhook returns False on HTTP error."""
        notifier = EscalationNotifier(channels=[EscalationChannel.WEBHOOK])

        with patch('requests.post') as mock_post:
            mock_post.return_value = Mock(status_code=500)
            result = notifier.notify_webhook(
                sample_escalation,
                webhook_url="https://example.com/hook"
            )

        assert result is False

    def test_notify_webhook_uses_config_url(self, sample_escalation):
        """Test that webhook uses configured URL when not specified."""
        config_url = "https://configured.com/hook"
        notifier = EscalationNotifier(
            channels=[EscalationChannel.WEBHOOK],
            config={"webhook_url": config_url}
        )

        with patch('requests.post') as mock_post:
            mock_post.return_value = Mock(status_code=200)
            notifier.notify_webhook(sample_escalation)

        call_args = mock_post.call_args
        assert call_args[0][0] == config_url


class TestFormatEscalation:
    """Test escalation formatting functionality."""

    @pytest.fixture
    def sample_escalation(self):
        """Create a sample escalation for testing."""
        return Escalation(
            id="esc-format-001",
            session_id="session-123",
            created_at=datetime(2025, 12, 31, 12, 0, 0),
            priority=EscalationPriority.HIGH,
            status=EscalationStatus.PENDING,
            reason="Format test",
            context={"key": "value"},
            recommended_actions=["Action 1"]
        )

    def test_format_escalation_text_format(self, sample_escalation):
        """Test formatting escalation as text."""
        notifier = EscalationNotifier(channels=[])

        result = notifier.format_escalation(sample_escalation, format="text")

        assert isinstance(result, str)
        assert "esc-format-001" in result
        assert "Format test" in result

    def test_format_escalation_json_format(self, sample_escalation):
        """Test formatting escalation as JSON."""
        notifier = EscalationNotifier(channels=[])

        result = notifier.format_escalation(sample_escalation, format="json")

        data = json.loads(result)
        assert data["id"] == "esc-format-001"
        assert data["reason"] == "Format test"

    def test_format_escalation_markdown_format(self, sample_escalation):
        """Test formatting escalation as markdown."""
        notifier = EscalationNotifier(channels=[])

        result = notifier.format_escalation(sample_escalation, format="markdown")

        assert isinstance(result, str)
        assert "#" in result or "**" in result  # Markdown formatting
        assert "esc-format-001" in result

    def test_format_escalation_default_is_text(self, sample_escalation):
        """Test that default format is text."""
        notifier = EscalationNotifier(channels=[])

        result1 = notifier.format_escalation(sample_escalation)
        result2 = notifier.format_escalation(sample_escalation, format="text")

        assert result1 == result2


class TestGetPriorityColor:
    """Test priority color code functionality."""

    def test_get_priority_color_returns_string(self):
        """Test that color code is returned as string."""
        notifier = EscalationNotifier(channels=[])

        for priority in EscalationPriority:
            color = notifier.get_priority_color(priority)
            assert isinstance(color, str)

    def test_get_priority_color_critical_is_red(self):
        """Test that CRITICAL priority uses red."""
        notifier = EscalationNotifier(channels=[])

        color = notifier.get_priority_color(EscalationPriority.CRITICAL)

        # ANSI red escape codes
        assert "\033[" in color or "red" in color.lower() or color != ""

    def test_get_priority_color_different_per_priority(self):
        """Test that different priorities have different colors."""
        notifier = EscalationNotifier(channels=[])

        colors = {
            p: notifier.get_priority_color(p)
            for p in EscalationPriority
        }

        # At least CRITICAL and LOW should differ
        assert colors[EscalationPriority.CRITICAL] != colors[EscalationPriority.LOW]


class TestEscalationNotifierIntegration:
    """Integration tests for EscalationNotifier."""

    def test_full_notification_flow(self):
        """Test complete notification through multiple channels."""
        with tempfile.TemporaryDirectory() as temp_dir:
            Path(temp_dir) / "test_esc.json"
            notifier = EscalationNotifier(
                channels=[EscalationChannel.CLI, EscalationChannel.FILE],
                config={"file_path_base": temp_dir}
            )

            escalation = Escalation(
                id="esc-integration-001",
                session_id="session-123",
                created_at=datetime.now(),
                priority=EscalationPriority.HIGH,
                status=EscalationStatus.PENDING,
                reason="Integration test",
                context={"test": True},
                recommended_actions=["Verify test"]
            )

            with patch('builtins.print'):
                results = notifier.notify(escalation)

            # CLI should succeed (mocked print)
            assert results.get(EscalationChannel.CLI) is True
            # FILE should succeed
            assert results.get(EscalationChannel.FILE) is True

    def test_format_all_priorities(self):
        """Test that all priorities format correctly."""
        notifier = EscalationNotifier(channels=[])

        for priority in EscalationPriority:
            escalation = Escalation(
                id=f"esc-{priority.name}",
                session_id="session",
                created_at=datetime.now(),
                priority=priority,
                status=EscalationStatus.PENDING,
                reason=f"Test {priority.name}",
                context={},
                recommended_actions=[]
            )

            text = notifier.format_escalation(escalation, format="text")
            assert priority.name in text.upper()
