schema_version: "1.0"

contract:
  name: "agentforge"
  type: patterns
  description: |
    AgentForge project contract with production-ready defaults.

    This contract enables meaningful checks by default while allowing
    customization based on tooling and workflow needs.

    Tier 1: Always enabled (errors) - Architecture, security
    Tier 2: Enabled by default (warnings) - Code quality
    Tier 3: Tool-dependent (disabled) - External tools
  version: "2.0.0"
  enabled: true
  extends:
    - "_architecture-python"
    - "_patterns-python"
    - "_typing-python"
    - "_security-python"
    - "_testing-python"
    - "_cli-python"
  applies_to:
    languages:
      - python
  tags:
    - agentforge
    - python
    - production

checks:
  # ===========================================================================
  # TIER 1: ALWAYS ENABLED - Errors
  # ===========================================================================

  # Architecture checks - DISABLED (custom functions not yet implemented)
  # These require AST-based analysis functions in builtin_checks.py
  - id: layer-dependency-violations
    enabled: false  # Requires layer_imports function
    severity: error

  - id: domain-purity
    enabled: false  # Requires domain_purity function
    severity: error

  - id: no-circular-imports
    enabled: false  # Requires circular_imports function
    severity: error

  # Security checks - ENABLED
  - id: no-secrets-in-code
    enabled: true
    severity: error

  - id: no-private-keys
    enabled: true
    severity: error

  - id: no-env-files
    enabled: true
    severity: error

  # Project-specific security
  - id: yaml-safe-load
    name: "Use yaml.safe_load"
    description: "Always use safe_load for YAML parsing"
    type: regex
    severity: error
    enabled: true
    config:
      pattern: "yaml\\.load\\s*\\([^)]*\\)(?!.*Loader)"
      mode: forbid
    applies_to:
      paths:
        - "**/*.py"
    fix_hint: "Use yaml.safe_load() instead of yaml.load()"

  # ===========================================================================
  # TIER 2: ENABLED BY DEFAULT - Warnings
  # ===========================================================================

  # Code quality metrics - ENABLED as warnings (relaxed for tests)
  - id: max-cyclomatic-complexity
    enabled: true
    severity: warning
    config:
      metric: cyclomatic_complexity
      threshold: 10
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"

  - id: max-function-length
    enabled: true
    severity: warning
    config:
      metric: function_length
      threshold: 50
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"

  - id: max-nesting-depth
    enabled: true
    severity: warning
    config:
      metric: nesting_depth
      threshold: 4
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"

  # CLI commands naturally have many parameters due to Click decorators
  - id: max-parameter-count
    enabled: true
    severity: warning
    config:
      metric: parameter_count
      threshold: 5
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "cli/click_commands/**"
        - "cli/main.py"
        - "**/tests/**"

  - id: max-class-size
    enabled: true
    severity: warning
    config:
      metric: class_size
      threshold: 20
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "**/tests/**"

  # Pattern checks - ENABLED
  - id: no-bare-except
    enabled: true
    severity: warning

  - id: no-star-imports
    enabled: true
    severity: warning

  - id: no-breakpoint
    enabled: true
    severity: error

  - id: no-pdb-import
    enabled: true
    severity: error

  # DI pattern - DISABLED (custom function not yet implemented)
  - id: constructor-injection-required
    enabled: false  # Requires constructor_injection function
    severity: warning

  # File structure - ENABLED
  - id: require-tools-init
    name: "Tools Package __init__.py"
    description: "tools directory must be a proper package"
    type: file_exists
    severity: warning
    enabled: true
    config:
      required_files:
        - "tools/__init__.py"
    fix_hint: "Create tools/__init__.py"

  - id: require-schemas-dir
    name: "Schemas Directory Required"
    description: "Project should have schemas directory"
    type: file_exists
    severity: warning
    enabled: true
    config:
      required_files:
        - "schemas/*.yaml"
    fix_hint: "Create schemas directory with YAML schema files"

  - id: require-builtin-contracts
    name: "Builtin Contracts Required"
    description: "Project should have builtin contract definitions"
    type: file_exists
    severity: warning
    enabled: true
    config:
      required_files:
        - "contracts/builtin/_base.contract.yaml"
    fix_hint: "Create builtin contract files in contracts/builtin/"

  - id: max-file-lines
    name: "Maximum File Lines"
    description: "Files should not exceed maximum line count"
    type: custom
    severity: warning
    enabled: true
    config:
      module: builtin_checks
      function: check_file_size
      params:
        max_lines: 500
        max_bytes: 100000
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "tests/**"
        - "**/test_*.py"
    fix_hint: "Split large files into smaller modules"

  # Contract validation - ENABLED
  - id: contract-schema-version
    name: "Contracts Have Schema Version"
    description: "All contract files must specify schema_version"
    type: regex
    severity: error
    enabled: true
    config:
      pattern: "^schema_version:\\s*['\"]?1\\.0['\"]?"
      mode: require
    applies_to:
      paths:
        - "contracts/**/*.contract.yaml"
    fix_hint: "Add 'schema_version: \"1.0\"' at the top of the contract file"

  - id: contract-has-name
    name: "Contracts Have Name"
    description: "All contracts must have a name field"
    type: regex
    severity: error
    enabled: true
    config:
      pattern: "contract:\\s*\\n\\s+name:"
      mode: require
      multiline: true
    applies_to:
      paths:
        - "contracts/**/*.contract.yaml"
    fix_hint: "Add 'name' field to contract definition"

  # Code quality rules - ENABLED
  - id: no-hardcoded-paths
    name: "No Hardcoded Absolute Paths"
    description: "Use Path objects and relative paths"
    type: regex
    severity: warning
    enabled: true
    config:
      pattern: "['\"]/(Users|home|opt|var)/"
      mode: forbid
    applies_to:
      paths:
        - "tools/**/*.py"
      exclude_paths:
        - "**/tests/**"
    fix_hint: "Use Path objects and relative paths from repo root"

  - id: use-pathlib
    name: "Use pathlib for Path Operations"
    description: "Use pathlib.Path instead of os.path"
    type: regex
    severity: info
    enabled: true
    config:
      pattern: "os\\.path\\.(join|exists|isfile|isdir|dirname|basename)"
      mode: forbid
    applies_to:
      paths:
        - "tools/**/*.py"
    fix_hint: "Use pathlib.Path: path.exists(), path.is_file(), path / 'subdir'"

  # ===========================================================================
  # LINEAGE AUDIT TRAIL - Enforces traceability
  # ===========================================================================

  # Files should have lineage metadata linking them to specs
  - id: missing-lineage
    name: "Missing Lineage Metadata"
    description: |
      Generated files should have lineage metadata in their header comments.
      This provides an audit trail from spec -> test -> implementation.
      Files without lineage cannot be properly verified during refactoring.
    type: custom
    severity: info  # Start as info, escalate after migration
    enabled: true
    config:
      module: builtin_checks
      function: check_lineage_metadata
    applies_to:
      paths:
        - "tools/**/*.py"
        - "tests/**/*.py"
      exclude_paths:
        - "**/__init__.py"
        - "**/conftest.py"
    fix_hint: |
      Add lineage header to file:
      # @spec_file: specs/your-spec.yaml
      # @spec_id: your-spec-id
      # @component_id: component-name
      # @test_path: tests/path/to/test.py
      Or regenerate file through TDFLOW to get proper lineage.

  # ===========================================================================
  # TIER 3: TOOL-DEPENDENT - Disabled until tools available
  # ===========================================================================

  # These check for tool availability before running
  - id: ruff-lint
    name: "Ruff Linting"
    type: command
    severity: warning
    enabled: false  # Enable with: pip install ruff
    config:
      command: "ruff"
      args: ["check", "."]
      prerequisite: "which ruff"

  - id: ruff-format
    name: "Ruff Formatting"
    type: command
    severity: info
    enabled: false
    config:
      command: "ruff"
      args: ["format", "--check", "."]
      prerequisite: "which ruff"

  - id: mypy-standard
    name: "mypy Type Check"
    type: command
    severity: warning
    enabled: false  # Enable with: pip install mypy
    config:
      command: "mypy"
      args: [".", "--ignore-missing-imports"]
      prerequisite: "which mypy"

  - id: pytest-pass
    name: "pytest Tests Pass"
    type: command
    severity: error
    enabled: false  # Enable when tests exist
    config:
      command: "pytest"
      args: ["tests/", "-v", "--tb=short"]
      prerequisite: "test -d tests"

  - id: bandit-scan
    name: "Bandit Security Scan"
    type: command
    severity: warning
    enabled: false
    config:
      command: "bandit"
      args: ["-r", ".", "-ll"]
      prerequisite: "which bandit"

  # ===========================================================================
  # OVERRIDES - Project-specific adjustments
  # ===========================================================================

  # CLI uses click.echo() for output - disable print check
  - id: no-print-statements
    enabled: false  # Legacy - CLI now uses click.echo()

  # Click patterns only apply to CLI definition files, not handler implementations
  # Override to match both @click.command and @group.command patterns
  # Exclude main.py (only has @click.group which gets help from docstring)
  - id: commands-have-help
    config:
      pattern: "@\\w+\\.command\\s*\\([^)]*help\\s*="
      mode: require
    applies_to:
      paths:
        - "cli/click_commands/*.py"
      exclude_paths:
        - "cli/click_commands/__init__.py"

  # Only check path validation in files that actually have path arguments
  - id: path-inputs-validated
    applies_to:
      paths:
        - "cli/click_commands/spec.py"
        - "cli/click_commands/utility.py"
        - "cli/click_commands/workspace.py"

  - id: validate-cli-inputs
    applies_to:
      paths:
        - "cli/main.py"
        - "cli/click_commands/*.py"
      exclude_paths:
        - "cli/click_commands/__init__.py"

  - id: options-have-help
    applies_to:
      paths:
        - "cli/main.py"
        - "cli/click_commands/*.py"
      exclude_paths:
        - "cli/click_commands/__init__.py"

  # Architecture checks relaxed for tests
  - id: no-god-classes
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "tests/**"
        - "**/test_*.py"

  - id: no-http-without-https
    applies_to:
      paths:
        - "**/*.py"
      exclude_paths:
        - "tests/**"
        - "**/test_*.py"

  # Project uses tools/ not src/ layout
  - id: require-init-files
    enabled: false  # Non-standard layout

  # execute.py is the entry point
  - id: require-main-entry
    enabled: false  # Using execute.py instead

  # Disable test directory checks (tests now exist)
  - id: require-tests-directory
    enabled: false  # Tests exist but in different structure

  - id: require-conftest
    enabled: false  # conftest.py exists in tests/
