# Operation Contract: Git Operations
# Governs git operations to ensure safe, traceable changes.
#
# These rules prevent destructive operations and enforce
# commit hygiene for autonomous code changes.

id: operation.git.v1
version: "1.0"
description: Governs git operations for safety and traceability

rules:
  - id: no-force-push
    description: Never force push without explicit approval
    check_type: command_constraint
    details:
      command: git push
      forbidden_flags: ["--force", "-f", "--force-with-lease"]
      unless: explicitly_approved
    severity: error
    rationale: |
      Force push can destroy commit history and disrupt collaborators.
      Must have explicit human approval for any force push.

  - id: no-main-direct
    description: Don't commit directly to main/master branches
    check_type: branch_constraint
    details:
      protected_branches: ["main", "master", "release/*", "prod"]
      allowed_actions: ["merge", "rebase"]
      forbidden_actions: ["direct_commit"]
    severity: error
    rationale: |
      Protected branches require review. Direct commits bypass
      code review and can introduce untested changes.

  - id: commit-message-format
    description: Commit messages must be descriptive
    check_type: message_constraint
    details:
      max_subject_length: 72
      require_body_for: ["feature", "refactor", "breaking"]
      forbidden_prefixes: ["WIP", "fixup", "squash"]
    severity: warning
    rationale: |
      Good commit messages explain WHY changes were made,
      not just WHAT changed. This aids future maintenance.

  - id: no-merge-conflicts
    description: Must resolve merge conflicts before proceeding
    check_type: state_constraint
    details:
      forbidden_states: ["MERGING", "CHERRY-PICKING", "REBASING"]
      action: escalate
    severity: error
    rationale: |
      Unresolved conflicts indicate complex situations requiring
      human judgment to resolve correctly.

  - id: clean-working-tree
    description: Working tree should be clean before major operations
    check_type: state_constraint
    details:
      operations: ["checkout", "rebase", "merge"]
      require: no_uncommitted_changes
      allow: stash_first
    severity: warning
    rationale: |
      Uncommitted changes can be lost during branch operations.
      Either commit, stash, or discard before proceeding.

  - id: no-rewrite-pushed
    description: Don't rewrite history that's been pushed
    check_type: history_constraint
    details:
      forbidden_on_pushed: ["rebase -i", "commit --amend", "reset --hard"]
      check: "origin tracking"
    severity: error
    rationale: |
      Rewriting pushed history requires force push and can
      cause significant issues for other collaborators.

  - id: preserve-hooks
    description: Don't bypass git hooks without explicit approval
    check_type: command_constraint
    details:
      forbidden_flags: ["--no-verify", "-n"]
      unless: explicitly_approved
    severity: warning
    rationale: |
      Git hooks enforce project standards. Bypassing them may
      introduce code that doesn't meet quality requirements.

escalation_triggers:
  - trigger_id: force-push-requested
    condition: Force push is needed to complete operation
    severity: blocking
    prompt: |
      Force push required. This will overwrite remote history.
      - Target branch: {branch}
      - Commits affected: {count}
      Please confirm this is intentional and collaborators are aware.
    rationale: Force push is irreversible and affects collaborators

  - trigger_id: protected-branch-access
    condition: Operation targets protected branch
    severity: blocking
    prompt: |
      Attempting to modify protected branch: {branch}
      This branch typically requires PR review. Should we:
      - Create a feature branch instead?
      - Proceed with explicit approval?
    rationale: Protected branches exist for safety

  - trigger_id: merge-conflict-detected
    condition: Git operation results in merge conflicts
    severity: blocking
    prompt: |
      Merge conflicts detected in {count} file(s):
      {files}
      Human review required to resolve conflicts correctly.
    rationale: Automatic conflict resolution may lose important changes

  - trigger_id: large-diff
    condition: Commit contains more than 500 lines changed
    severity: advisory
    prompt: |
      Large commit detected: {lines} lines changed across {files} files.
      Consider:
      - Breaking into smaller, focused commits
      - Reviewing changes for completeness
    rationale: Large commits are harder to review and may hide issues

quality_gates:
  - gate_id: pre-commit-check
    checks:
      - No uncommitted changes (or explicitly stashed)
      - Not on protected branch
      - Commit message follows format
    failure_action: escalate

  - gate_id: pre-push-check
    checks:
      - All commits have valid messages
      - No force push flags unless approved
      - Remote tracking is current
    failure_action: escalate
