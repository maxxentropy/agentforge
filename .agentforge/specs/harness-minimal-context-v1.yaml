# ═══════════════════════════════════════════════════════════════════════════════
# Specification: harness_minimal_context
# ═══════════════════════════════════════════════════════════════════════════════
# Generated: 2026-01-01T16:08:00.972747
# Generator: brownfield-discovery
# ═══════════════════════════════════════════════════════════════════════════════

spec_id: harness-minimal-context-v1
name: harness_minimal_context
version: '1.0'
status: as-built
schema_version: '2.0'
generated_at: '2026-01-01T16:08:00.972747'
generated_by: brownfield-discovery
description: Specification for tools/harness/minimal_context
components:
- name: executor
  component_id: harness-minimal_context-executor
  location: tools/harness/minimal_context/executor.py
  test_location: tests/unit/harness/test_action_parser.py
  description: 'Minimal Context Executor

    ========================


    Executes agent steps with stateless, bounded context.

    Each step is a fresh conversation with exactly 2 messages.


    Key guarantees:

    - Step 1 and Step 100 use same token count (±10%)

    - No step exceeds 8K tokens

    - All state recoverable from disk after crash

    - Rate limits never exceeded'
  entities:
  - name: StepOutcome
    type: dataclass
    line_number: 33
    description: Result of executing a single step.
    methods:
    - to_dict
    test_methods: []
  - name: AdaptiveBudget
    type: class
    line_number: 63
    description: 'Adaptive step budget that prevents runaway while allowing complex
      tasks.


      Key behaviors:

      1. RUNAWAY DETECTION: Stop after 3 consecutive identical failures

      2. NO-PROGRESS DETECTION: Stop after 3 steps with zero meaningful progress

      3. PROGRESS EXTENSION: Extend budget when making progress (file mods, violation
      reduction)

      4. HARD CEILING: Never exceed max_budget (cost control)'
    methods:
    - check_continue
    test_methods: []
  - name: MinimalContextExecutor
    type: class
    line_number: 221
    description: 'Executes agent steps with minimal, stateless context.


      Each step:

      1. Loads current state from disk

      2. Builds minimal context (always 4-8K tokens)

      3. Calls LLM with fresh 2-message conversation

      4. Parses and executes the action

      5. Updates state on disk'
    methods:
    - register_action
    - register_actions
    - execute_step
    - run_until_complete
    test_methods: []
  - name: create_minimal_executor
    type: function
    line_number: 646
    description: "Factory function to create a minimal context executor.\n\nArgs:\n\
      \    project_path: Project root path\n    action_executors: Optional action\
      \ executors\n    model: Model to use\n\nReturns:\n    Configured MinimalContextExecutor"
    methods: []
    test_methods: []
- name: working_memory
  component_id: harness-minimal_context-working_memory
  location: tools/harness/minimal_context/working_memory.py
  test_location: tests/unit/harness/test_enhanced_context.py
  description: 'Working Memory Manager

    ======================


    Manages the bounded rolling buffer of recent context items.

    Items are automatically evicted (FIFO) when the buffer is full,

    unless marked as pinned.'
  entities:
  - name: WorkingMemoryItem
    type: dataclass
    line_number: 18
    description: Single item in working memory.
    methods:
    - to_dict
    - from_dict
    - is_expired
    test_methods: []
  - name: WorkingMemoryManager
    type: class
    line_number: 58
    description: 'Manages a bounded rolling buffer of context items.


      The working memory is persisted to disk and loaded fresh each step.

      Items are automatically evicted when the buffer is full (FIFO),

      unless they are pinned.'
    methods:
    - add
    - add_action_result
    - load_context
    - get_items
    - get_by_type
    - get_action_results
    - get_loaded_context
    - remove
    - clear
    - pin
    - unpin
    test_methods: []
- name: fix_workflow
  component_id: harness-minimal_context-fix_workflow
  location: tools/harness/minimal_context/fix_workflow.py
  test_location: tests/unit/harness/test_enhanced_context.py
  description: 'Minimal Context Fix Workflow

    ============================


    Fix violation workflow using the minimal context architecture.

    Each step is a fresh conversation with bounded context.


    Test verification uses the violation''s test_path field, which is computed

    at violation detection time from:

    1. Lineage metadata embedded in the source file (explicit, auditable)

    2. Convention-based detection (fallback for legacy files)'
  entities:
  - name: MinimalContextFixWorkflow
    type: class
    line_number: 38
    description: 'Fix violation workflow using minimal context architecture.


      Key differences from FixViolationWorkflow:

      - State persisted to disk, not in memory

      - Each step is a fresh 2-message conversation

      - Token usage bounded regardless of step count

      - Resumable after crashes'
    methods:
    - fix_violation
    - resume_task
    test_methods: []
  - name: create_minimal_fix_workflow
    type: function
    line_number: 1404
    description: "Factory function to create a MinimalContextFixWorkflow.\n\nArgs:\n\
      \    project_path: Project root directory\n    require_commit_approval: Require\
      \ human approval for commits\n    base_iterations: Initial step budget (extends\
      \ with progress)\n    max_iterations: Hard ceiling for steps (cost control)\n\
      \nReturns:\n    Configured MinimalContextFixWorkflow"
    methods: []
    test_methods: []
- name: state_store
  component_id: harness-minimal_context-state_store
  location: tools/harness/minimal_context/state_store.py
  test_location: tests/unit/harness/test_minimal_context.py
  description: "Task State Store\n================\n\nManages task state persistence\
    \ to disk.\nAll agent state lives here - the agent has no memory except what's\
    \ in the state store.\n\nDirectory structure:\n.agentforge/tasks/{task_id}/\n\
    ├── task.yaml                 # Immutable: goal, success criteria\n├── state.yaml\
    \                # Mutable: current phase, status, verification\n├── actions.yaml\
    \              # Append-only: complete log of all actions\n├── working_memory.yaml\
    \       # Rolling: last N actions for context\n└── artifacts/\n    ├── inputs/\
    \               # Verified inputs (spec, violation, etc.)\n    ├── outputs/  \
    \            # Verified outputs from each phase\n    └── snapshots/          \
    \  # File states before/after changes"
  entities:
  - name: TaskPhase
    type: enum
    line_number: 29
    description: Task execution phases.
    methods: []
    test_methods: []
  - name: ActionRecord
    type: dataclass
    line_number: 43
    description: Record of an action taken during execution.
    methods:
    - to_dict
    - from_dict
    test_methods: []
  - name: VerificationStatus
    type: dataclass
    line_number: 84
    description: Current verification status for a task.
    methods:
    - to_dict
    - from_dict
    test_methods: []
  - name: TaskState
    type: dataclass
    line_number: 116
    description: Complete state for a task.
    methods:
    - to_task_dict
    - to_state_dict
    test_methods: []
  - name: TaskStateStore
    type: class
    line_number: 159
    description: 'Manages task state on disk.


      All agent state persists here. The agent has no memory except what''s

      loaded from the state store at the start of each step.'
    methods:
    - create_task
    - load
    - update_phase
    - increment_step
    - record_action
    - get_recent_actions
    - update_verification
    - update_context_data
    - set_error
    - save_artifact
    - load_artifact
    - list_tasks
    - delete_task
    test_methods: []
- name: token_budget
  component_id: harness-minimal_context-token_budget
  location: tools/harness/minimal_context/token_budget.py
  test_location: tests/unit/harness/test_minimal_context.py
  description: 'Token Budget Enforcement

    ========================


    Enforces hard token limits for each context component.

    Ensures total context never exceeds 8K tokens.'
  entities:
  - name: estimate_tokens
    type: function
    line_number: 29
    description: 'Estimate token count for text.


      Uses a conservative 4 chars/token estimate.

      For accurate counts, use the provider''s tokenizer.'
    methods: []
    test_methods:
    - test_estimate_tokens
    - test_estimate_tokens_empty
  - name: BudgetAllocation
    type: dataclass
    line_number: 42
    description: Token allocation for a content section.
    methods: []
    test_methods: []
  - name: TokenBudget
    type: class
    line_number: 52
    description: Enforces token budget limits with compression strategies.
    methods:
    - check_allocation
    - compress_to_fit
    - allocate_all
    - get_total_tokens
    - is_within_budget
    test_methods: []
  - name: truncate_with_ellipsis
    type: function
    line_number: 154
    description: Simple truncation with ellipsis.
    methods: []
    test_methods: []
  - name: compress_file_content
    type: function
    line_number: 162
    description: 'Compress file content, keeping first/last lines.


      Shows first N lines, middle replaced with omission marker, last M lines.'
    methods: []
    test_methods:
    - test_compress_file_content
  - name: compress_recent_actions
    type: function
    line_number: 207
    description: 'Compress action list by keeping only most recent.


      Parses YAML-like action entries and keeps the last N that fit.'
    methods: []
    test_methods:
    - test_compress_recent_actions
  - name: compress_error_message
    type: function
    line_number: 241
    description: Compress error messages to first 500 chars.
    methods: []
    test_methods: []
  - name: compress_list_items
    type: function
    line_number: 257
    description: 'Compress list by keeping first N items.


      Detects YAML list format (- item) and keeps items that fit.'
    methods: []
    test_methods: []
- name: context_builder
  component_id: harness-minimal_context-context_builder
  location: tools/harness/minimal_context/context_builder.py
  test_location: tests/unit/harness/test_minimal_context.py
  description: 'Context Builder

    ===============


    Builds minimal context for each step from persisted state.

    Guarantees token budget compliance.'
  entities:
  - name: StepContext
    type: dataclass
    line_number: 21
    description: Complete context for a single step.
    methods: []
    test_methods: []
  - name: ContextBuilder
    type: class
    line_number: 29
    description: 'Builds minimal context from task state.


      Guarantees:

      - Total tokens never exceed max_tokens (default 8000)

      - Same token count for step 1 and step 100

      - All context built from disk state (no memory)'
    methods:
    - build
    - build_messages
    - get_token_breakdown
    test_methods: []
  - name: create_context_builder
    type: function
    line_number: 243
    description: "Factory function to create a context builder.\n\nArgs:\n    project_path:\
      \ Project root path\n    max_tokens: Maximum total tokens\n\nReturns:\n    Configured\
      \ ContextBuilder"
    methods: []
    test_methods: []
- name: context_schemas
  component_id: harness-minimal_context-context_schemas
  location: tools/harness/minimal_context/context_schemas.py
  test_location: tests/unit/harness/test_minimal_context.py
  description: 'Context Schemas

    ===============


    Defines context schemas for different task types.

    Each schema specifies what data is included in the context and how to format it.'
  entities:
  - name: AvailableAction
    type: dataclass
    line_number: 20
    description: Definition of an action the agent can take.
    methods: []
    test_methods: []
  - name: ContextSchema
    type: class
    line_number: 27
    description: Base class for context schemas.
    methods:
    - get_current_state
    - get_available_actions
    - get_system_prompt
    - format_task_frame
    - format_verification_status
    - format_available_actions
    test_methods: []
  - name: FixViolationSchema
    type: class
    line_number: 122
    description: Context schema for fix_violation tasks.
    methods:
    - get_current_state
    - get_available_actions
    test_methods: []
  - name: ImplementFeatureSchema
    type: class
    line_number: 263
    description: Context schema for implement_feature tasks.
    methods:
    - get_current_state
    - get_available_actions
    test_methods: []
  - name: WriteTestsSchema
    type: class
    line_number: 324
    description: Context schema for write_tests (RED phase) tasks.
    methods:
    - get_current_state
    - get_available_actions
    test_methods: []
  - name: get_schema_for_task
    type: function
    line_number: 615
    description: "Get the appropriate schema for a task type.\n\nArgs:\n    task_type:\
      \ Type of task\n    project_path: Project root path\n\nReturns:\n    ContextSchema\
      \ instance"
    methods: []
    test_methods:
    - test_get_schema_for_task
- name: __init__
  component_id: harness-minimal_context-__init__
  location: tools/harness/minimal_context/__init__.py
  test_location: tests/unit/harness/test_minimal_context.py
  description: 'Minimal Context Architecture

    ============================


    Implements stateless step execution with verified state.


    Key principle: Each step is a fresh conversation with exactly 2 messages:

    1. System prompt (phase-appropriate)

    2. Current context (built from persisted state)


    Context size: 4-8K tokens ALWAYS, regardless of step number.'
  entities: []
