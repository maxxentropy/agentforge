# @spec_file: .agentforge/specs/core-harness-v1.yaml
# @spec_id: core-harness-v1
# @component_id: core-harness-memory_domain
# @test_path: tests/unit/harness/test_memory_domain.py

# Generated by AgentForge
# Spec: unknown
# Phase: green
# Date: 2025-12-31 05:10:06 UTC

"""Domain entities for the memory system."""

from datetime import datetime, timedelta
from enum import Enum
from typing import Any, Dict, Optional


class MemoryTier(Enum):
    """Enumeration of memory tiers in the hierarchy."""
    SESSION = "session"
    TASK = "task"
    PROJECT = "project"
    ORGANIZATION = "organization"


class MemoryEntry:
    """A memory entry with key, value, timestamp, and optional metadata."""
    
    def __init__(
        self,
        key: str,
        value: Any,
        created_at: datetime,
        ttl: Optional[int] = None,
        metadata: Optional[Dict[str, Any]] = None
    ):
        """Initialize a memory entry.
        
        Args:
            key: The entry key
            value: The entry value
            created_at: Creation timestamp
            ttl: Time to live in seconds
            metadata: Optional metadata dictionary
        """
        self.key = key
        self.value = value
        self.created_at = created_at
        self.ttl = ttl
        self.metadata = metadata

        # Calculate expiration time if TTL is provided
        if ttl is not None:
            self.expires_at = created_at + timedelta(seconds=ttl)
        else:
            self.expires_at = None
    
    @classmethod
    def create(
        cls,
        key: str,
        value: Any,
        ttl: Optional[int] = None,
        metadata: Optional[Dict[str, Any]] = None
    ) -> "MemoryEntry":
        """Factory method to create a memory entry with current timestamp.
        
        Args:
            key: The entry key
            value: The entry value
            ttl: Time to live in seconds
            metadata: Optional metadata dictionary
            
        Returns:
            A new MemoryEntry instance
        """
        return cls(
            key=key,
            value=value,
            created_at=datetime.now(),
            ttl=ttl,
            metadata=metadata
        )
    
    def is_expired(self) -> bool:
        """Check if the entry has expired.

        Returns:
            True if entry has TTL and is past expiration, False otherwise
        """
        if self.expires_at is None:
            return False

        return datetime.now() >= self.expires_at

    @property
    def timestamp(self) -> datetime:
        """Alias for created_at for convenience."""
        return self.created_at

    def to_dict(self) -> Dict[str, Any]:
        """Serialize entry to dictionary for YAML storage.
        
        Returns:
            Dictionary representation of the entry
        """
        result = {
            "key": self.key,
            "value": self.value,
            "created_at": self.created_at
        }
        
        if self.ttl is not None:
            result["ttl"] = self.ttl
            
        if self.metadata is not None:
            result["metadata"] = self.metadata
            
        return result
    
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> "MemoryEntry":
        """Deserialize entry from dictionary.
        
        Args:
            data: Dictionary containing entry data
            
        Returns:
            A new MemoryEntry instance
        """
        return cls(
            key=data["key"],
            value=data["value"],
            created_at=data["created_at"],
            ttl=data.get("ttl"),
            metadata=data.get("metadata")
        )
