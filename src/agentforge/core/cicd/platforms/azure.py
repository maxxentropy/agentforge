"""
Azure DevOps Integration
========================

Azure DevOps-specific CI/CD integration including pipeline templates
and PR comment generation.
"""

AZURE_PIPELINE_TEMPLATE = '''# AgentForge Conformance Check
# Generated by: agentforge ci init --platform azure
#
# Runs both:
# 1. User-defined contracts (from .agentforge/contracts/)
# 2. Operation contracts (built-in code generation rules)
#
# Operation contracts check:
# - Function size limits (30 lines max)
# - Cyclomatic complexity (10 max)
# - Parameter count (5 max)
# - Nesting depth (4 max)
# - Naming conventions (boolean prefixes, descriptive names)
# - Security patterns (no hardcoded secrets)

trigger:
  branches:
    include:
      - main
      - master

pr:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'

stages:
  - stage: Conformance
    displayName: 'Conformance Check'
    jobs:
      - job: Check
        displayName: 'Run Conformance Checks'
        steps:
          - checkout: self
            fetchDepth: 0  # Full history for baseline comparison

          - task: UsePythonVersion@0
            displayName: 'Set up Python'
            inputs:
              versionSpec: '$(pythonVersion)'
              addToPath: true

          - script: |
              pip install agentforge
              # Or for development: pip install -e .
            displayName: 'Install AgentForge'

          - script: |
              if [ "$(Build.Reason)" = "PullRequest" ]; then
                agentforge ci run \\
                  --mode pr \\
                  --base-ref origin/$(System.PullRequest.TargetBranch) \\
                  --output-junit \\
                  --output-markdown
              else
                agentforge ci run \\
                  --mode full \\
                  --output-junit
              fi
            displayName: 'Run Conformance Check'
            continueOnError: true

          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '.agentforge/results.xml'
              testRunTitle: 'AgentForge Conformance'
              failTaskOnFailedTests: false

          - script: |
              if [ -f ".agentforge/results.md" ]; then
                echo "##vso[task.uploadsummary].agentforge/results.md"
              fi
            displayName: 'Upload Summary'
            condition: always()

          - script: |
              # Post PR comment using Azure DevOps REST API
              if [ "$(Build.Reason)" = "PullRequest" ] && [ -f ".agentforge/results.md" ]; then
                CONTENT=$(cat .agentforge/results.md)

                # Use Azure DevOps API to post comment
                # Note: Requires System.AccessToken with PR comment permissions
                curl -X POST \\
                  -H "Authorization: Bearer $(System.AccessToken)" \\
                  -H "Content-Type: application/json" \\
                  -d "{\\"comments\\": [{\\"parentCommentId\\": 0, \\"content\\": \\"${CONTENT//\"/\\\\\"}\\", \\"commentType\\": 1}], \\"status\\": 1}" \\
                  "$(System.CollectionUri)$(System.TeamProject)/_apis/git/repositories/$(Build.Repository.Name)/pullRequests/$(System.PullRequest.PullRequestId)/threads?api-version=7.0"
              fi
            displayName: 'Post PR Comment'
            condition: eq(variables['Build.Reason'], 'PullRequest')
            env:
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)

          - script: |
              # Update baseline on main branch
              if [ "$(Build.SourceBranch)" = "refs/heads/main" ] || [ "$(Build.SourceBranch)" = "refs/heads/master" ]; then
                agentforge ci baseline save --force

                if ! git diff --quiet .agentforge/baseline.json; then
                  git config user.name "Azure DevOps"
                  git config user.email "azuredevops@microsoft.com"
                  git add .agentforge/baseline.json
                  git commit -m "Update conformance baseline [skip ci]"
                  git push origin HEAD:$(Build.SourceBranchName)
                fi
              fi
            displayName: 'Update Baseline'
            condition: and(succeeded(), in(variables['Build.SourceBranch'], 'refs/heads/main', 'refs/heads/master'))
'''


def generate_azure_pr_comment_body(markdown_content: str) -> str:
    """
    Format markdown content for Azure DevOps PR comment.

    Azure DevOps uses a slightly different markdown flavor.
    """
    # Azure DevOps supports standard markdown
    return markdown_content
