# Operation Contract: Safety Rules
# Fundamental safety constraints that always apply.
#
# These rules protect against destructive operations,
# security vulnerabilities, and irreversible mistakes.

id: operation.safety.v1
version: "1.0"
description: Safety constraints that always apply

rules:
  - id: no-secrets-in-code
    description: Never commit secrets or credentials
    check_type: content_constraint
    details:
      patterns:
        - "api[_-]?key\\s*[:=]\\s*['\"][^'\"]{10,}"
        - "secret\\s*[:=]\\s*['\"][^'\"]{10,}"
        - "password\\s*[:=]\\s*['\"][^'\"]{4,}"
        - "token\\s*[:=]\\s*['\"][^'\"]{10,}"
        - "-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----"
        - "AKIA[0-9A-Z]{16}"  # AWS Access Key
      excluded_files: ["*.example", "*.template", "test_*.py", "*_test.go"]
      action: block_commit
    severity: error
    rationale: |
      Secrets in code are a critical security vulnerability.
      Use environment variables or secret management instead.

  - id: no-destructive-system
    description: Avoid destructive shell commands
    check_type: command_constraint
    details:
      forbidden_patterns:
        - "rm -rf /"
        - "rm -rf ~"
        - "rm -rf /*"
        - "> /dev/sd"
        - "mkfs\\."
        - ":(){:|:&};:"
      forbidden_directories:
        - "/"
        - "/etc"
        - "/usr"
        - "/var"
        - "/bin"
        - "/sbin"
        - "/boot"
        - "~"
        - "$HOME"
    severity: error
    rationale: |
      Destructive system commands can cause irreversible damage.
      These patterns are almost never appropriate for application code.

  - id: no-chmod-777
    description: Don't grant excessive permissions
    check_type: command_constraint
    details:
      forbidden_patterns:
        - "chmod 777"
        - "chmod -R 777"
        - "chmod a+rwx"
    severity: error
    rationale: |
      World-writable files are a security risk. Use specific
      permissions (644 for files, 755 for executables).

  - id: no-sudo-without-approval
    description: Sudo requires explicit approval
    check_type: command_constraint
    details:
      pattern: "^sudo"
      unless: explicitly_approved
    severity: error
    rationale: |
      Elevated privileges can cause system-wide damage.
      Human approval required for any privileged operations.

  - id: preserve-existing-tests
    description: Don't delete tests without explanation
    check_type: deletion_constraint
    details:
      protected_patterns:
        - "test_*.py"
        - "*_test.py"
        - "*_test.go"
        - "*.test.js"
        - "*.test.ts"
        - "*.spec.js"
        - "*.spec.ts"
      action: require_explanation
    severity: warning
    rationale: |
      Tests are critical for code quality. Deletions should be
      intentional and explained, not accidental.

  - id: no-disable-security
    description: Don't disable security features
    check_type: content_constraint
    details:
      patterns:
        - "verify\\s*=\\s*False"
        - "ssl[_-]verify.*false"
        - "CURLOPT_SSL_VERIFYPEER.*false"
        - "disable-ssl"
        - "no-verify-ssl"
        - "insecure"
      action: escalate
    severity: error
    rationale: |
      Disabling security features (like SSL verification) creates
      vulnerabilities. Should only be done with explicit approval.

  - id: no-eval-user-input
    description: Don't eval untrusted input
    check_type: code_pattern
    details:
      dangerous_patterns:
        - "eval\\(.*request"
        - "eval\\(.*input"
        - "exec\\(.*request"
        - "exec\\(.*input"
        - "__import__\\(.*request"
        - "subprocess.*shell=True.*request"
      action: escalate
    severity: error
    rationale: |
      Evaluating user input leads to code injection vulnerabilities.
      Always sanitize and validate inputs.

  - id: backup-before-bulk
    description: Backup before bulk destructive operations
    check_type: operation_guard
    details:
      operations:
        - "DELETE FROM .* WHERE"
        - "DROP TABLE"
        - "TRUNCATE"
        - "rm -rf"
      require: backup_confirmation
    severity: warning
    rationale: |
      Bulk deletions are hard to undo. Having a backup
      provides recovery options if something goes wrong.

escalation_triggers:
  - trigger_id: security-sensitive-op
    condition: Any security-sensitive operation detected
    severity: blocking
    prompt: |
      Security-sensitive operation detected:
      {operation}

      This requires human approval before proceeding.
      Please confirm this is intentional and secure.
    rationale: Security decisions should always involve human judgment

  - trigger_id: potential-secret-exposure
    condition: Content matching secret patterns detected
    severity: blocking
    prompt: |
      Potential secret detected:
      File: {file}
      Pattern: {pattern}

      Is this a real secret or a false positive?
      If real, it should be moved to environment variables.
    rationale: Secret exposure is a critical security risk

  - trigger_id: destructive-file-op
    condition: Bulk file deletion requested
    severity: blocking
    prompt: |
      Destructive file operation requested:
      {operation}
      Affected: {count} files

      Please confirm this is intentional.
      Consider creating a backup first.
    rationale: Bulk deletions are difficult to reverse

  - trigger_id: permission-change
    condition: File permission modification requested
    severity: advisory
    prompt: |
      Permission change requested:
      {operation}

      Verify these permissions are appropriate for the file type.
    rationale: Incorrect permissions can create security vulnerabilities

quality_gates:
  - gate_id: security-review
    checks:
      - No secrets in committed code
      - No disabled security features
      - No dangerous eval patterns
      - Permissions are appropriate
    failure_action: escalate

  - gate_id: pre-deploy-safety
    checks:
      - All safety rules pass
      - No pending security escalations
      - No destructive operations pending
    failure_action: abort
