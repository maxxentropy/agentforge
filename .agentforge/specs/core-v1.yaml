# ═══════════════════════════════════════════════════════════════════════════════
# Specification: core
# ═══════════════════════════════════════════════════════════════════════════════
# Generated: 2026-01-01T16:07:58.515498
# Generator: brownfield-discovery
# ═══════════════════════════════════════════════════════════════════════════════

spec_id: core-v1
name: core
version: '1.0'
status: as-built
schema_version: '2.0'
generated_at: '2026-01-01T16:07:58.515498'
generated_by: brownfield-discovery
description: Specification for src/agentforge/core
components:
- name: pyright_runner
  component_id: agentforge-core-pyright_runner
  location: src/agentforge/core/pyright_runner.py
  test_location: tests/test_python_checks.py
  description: 'Pyright runner for AgentForge contract checks.


    This module provides semantic Python analysis using pyright''s CLI.

    It does NOT use LSP protocol - it executes pyright as a subprocess

    and parses the JSON output.'
  entities:
  - name: PyrightDiagnostic
    type: dataclass
    line_number: 19
    description: A single diagnostic from pyright.
    methods: []
    test_methods: []
  - name: PyrightResult
    type: dataclass
    line_number: 30
    description: Result of running pyright.
    methods: []
    test_methods: []
  - name: PyrightRunner
    type: class
    line_number: 40
    description: 'Runs pyright CLI and parses results.


      This is NOT an LSP client. It simply executes pyright as a subprocess

      and parses the JSON output.'
    methods:
    - check_file
    - check_directory
    - check_project
    test_methods: []
  - name: check_python_types
    type: function
    line_number: 190
    description: "Check Python types in a file or directory.\n\nArgs:\n    path: File\
      \ or directory to check.\n\nReturns:\n    PyrightResult with diagnostics.\n\n\
      Example:\n    result = check_python_types(\"src/mymodule.py\")\n    if not result.success:\n\
      \        for diag in result.diagnostics:\n            print(f\"{diag.file}:{diag.line}:\
      \ {diag.message}\")"
    methods: []
    test_methods: []
- name: command_runner
  component_id: agentforge-core-command_runner
  location: src/agentforge/core/command_runner.py
  test_location: tests/test_python_checks.py
  description: 'Command runner for external tool execution.


    Runs linting/analysis tools as subprocesses and parses their output.'
  entities:
  - name: CommandResult
    type: dataclass
    line_number: 17
    description: Result of running an external command.
    methods: []
    test_methods: []
  - name: CommandRunner
    type: class
    line_number: 26
    description: Runs external commands for contract checks.
    methods:
    - run
    - run_ruff_check
    - run_ruff_format_check
    - run_mypy
    - run_bandit
    - run_radon_cc
    test_methods: []
- name: verification_runner
  component_id: agentforge-core-verification_runner
  location: src/agentforge/core/verification_runner.py
  test_location: tests/test_python_checks.py
  description: "Verification Runner\n====================\n\nDeterministic verification\
    \ engine that runs actual checks instead of LLM judgment.\nImplements \"Correctness\
    \ is Upstream\" philosophy.\n\nCheck Types:\n  - command: Shell commands (dotnet\
    \ build, dotnet test, etc.)\n  - regex: Pattern matching on source files\n  -\
    \ file_exists: Verify required files exist\n  - import_check: Verify layer/import\
    \ dependencies\n  - custom: Python function for complex checks\n  - contracts:\
    \ Run contract-based checks from the contracts module\n\nUsage:\n    python tools/verification_runner.py\
    \ --profile ci --project MyProject.csproj\n    python tools/verification_runner.py\
    \ --checks compile_check,test_check"
  entities:
  - name: VerificationRunner
    type: class
    line_number: 50
    description: 'Runs verification checks defined in correctness.yaml.


      Replaces LLM-based validation with deterministic verification.'
    methods:
    - pyright_runner
    - command_runner
    - ast_checker
    - set_context
    - get_checks_for_profile
    - get_checks_by_ids
    - run_profile
    - run_checks
    - run_check
    test_methods: []
  - name: main
    type: function
    line_number: 278
    description: ''
    methods: []
    test_methods: []
- name: context_assembler
  component_id: agentforge-core-context_assembler
  location: src/agentforge/core/context_assembler.py
  test_location: tests/unit/tools/test_context_retrieval.py
  description: 'Context Assembler

    =================


    Merges structural (LSP) and semantic (Vector) retrieval results.

    Enforces token budget with intelligent prioritization.


    Strategy:

    1. LSP: Get precise structural information (symbols, definitions, references)

    2. Vector: Get semantically related code chunks

    3. Merge: Combine results, deduplicate, rank by relevance

    4. Budget: Truncate to fit token limit with priority ordering


    Priority Order:

    1. Exact symbol matches from query

    2. High-relevance vector results

    3. Definitions of referenced symbols

    4. Related code from same layer'
  entities:
  - name: ContextAssembler
    type: class
    line_number: 45
    description: 'Assembles final context from multiple retrieval sources.


      Combines LSP (structural) and Vector (semantic) results,

      manages token budget, and formats for LLM consumption.'
    methods:
    - detect_layer
    - detect_language
    - estimate_tokens
    - assemble
    - assemble_from_files
    test_methods: []
  - name: main
    type: function
    line_number: 399
    description: ''
    methods: []
    test_methods:
    - test_detect_domain_layer
- name: context_retrieval_cli
  component_id: agentforge-core-context_retrieval_cli
  location: src/agentforge/core/context_retrieval_cli.py
  test_location: tests/unit/tools/test_context_retrieval.py
  description: 'Context Retrieval CLI

    =====================


    Command-line interface for context retrieval.


    Extracted from context_retrieval.py for modularity.'
  entities:
  - name: build_parser
    type: function
    line_number: 15
    description: Build argument parser for context retrieval CLI.
    methods: []
    test_methods: []
  - name: run_check_command
    type: function
    line_number: 45
    description: Run the check command to display component status.
    methods: []
    test_methods: []
  - name: run_index_command
    type: function
    line_number: 72
    description: Run the index command to build vector index.
    methods: []
    test_methods: []
  - name: run_search_command
    type: function
    line_number: 83
    description: Run the search command.
    methods: []
    test_methods: []
  - name: run_symbol_command
    type: function
    line_number: 104
    description: Run the symbol command.
    methods: []
    test_methods: []
  - name: dispatch_command
    type: function
    line_number: 115
    description: Dispatch to appropriate command handler.
    methods: []
    test_methods: []
  - name: main
    type: function
    line_number: 130
    description: Main entry point for CLI.
    methods: []
    test_methods: []
- name: context_assembler_types
  component_id: agentforge-core-context_assembler_types
  location: src/agentforge/core/context_assembler_types.py
  test_location: tests/unit/tools/test_context_retrieval.py
  description: 'Context Assembler Types

    =======================


    Data classes for context assembly.


    Extracted from context_assembler.py for modularity.'
  entities:
  - name: ArchitectureLayer
    type: enum
    line_number: 16
    description: Clean Architecture layers.
    methods: []
    test_methods: []
  - name: SymbolInfo
    type: dataclass
    line_number: 26
    description: Information about a code symbol.
    methods:
    - to_dict
    test_methods: []
  - name: FileContext
    type: dataclass
    line_number: 45
    description: Context for a single file.
    methods:
    - to_dict
    test_methods: []
  - name: PatternMatch
    type: dataclass
    line_number: 67
    description: Detected architectural pattern.
    methods:
    - to_dict
    test_methods: []
  - name: CodeContext
    type: dataclass
    line_number: 83
    description: Complete assembled context for LLM consumption.
    methods:
    - to_dict
    - to_yaml
    - to_prompt_text
    test_methods: []
- name: context_retrieval
  component_id: agentforge-core-context_retrieval
  location: src/agentforge/core/context_retrieval.py
  test_location: tests/unit/tools/test_context_retrieval.py
  description: "Context Retrieval System\n========================\n\nHybrid LSP +\
    \ Vector retrieval for code context.\nImplements \"Correctness is Upstream\" -\
    \ agents need real code to write accurate specs.\n\nThis is the main entry point\
    \ that combines:\n- LSP: Compiler-accurate structural information (symbols, definitions,\
    \ references)\n- Vector: Semantic similarity search (related code, concepts)\n\
    \nUsage:\n    from agentforge.core.context_retrieval import ContextRetriever\n\
    \n    retriever = ContextRetriever(project_path=\"/path/to/project\")\n    context\
    \ = retriever.retrieve(\n        query=\"discount code handling\",\n        budget_tokens=6000\n\
    \    )\n\nDependencies:\n    Required: pip install pyyaml\n    For vector search:\
    \ pip install openai faiss-cpu\n    For C#: dotnet tool install -g csharp-ls"
  entities:
  - name: IndexStats
    type: dataclass
    line_number: 46
    description: Statistics from indexing operation.
    methods: []
    test_methods: []
  - name: ContextRetriever
    type: class
    line_number: 59
    description: "Main entry point for context retrieval.\n\nCombines LSP (structural)\
      \ and Vector (semantic) search to provide\ncomprehensive code context for LLM\
      \ consumption.\n\nExample:\n    retriever = ContextRetriever(\"/path/to/dotnet/project\"\
      )\n    context = retriever.retrieve(\"order discount processing\", budget_tokens=6000)\n\
      \    print(context.to_prompt_text())"
    methods:
    - assembler
    - lsp_adapter
    - vector_search
    - retrieve
    - get_symbol_context
    - get_file_context
    - index
    - check_dependencies
    - shutdown
    test_methods: []
- name: contracts_execution
  component_id: agentforge-core-contracts_execution
  location: src/agentforge/core/contracts_execution.py
  test_location: tests/unit/tools/test_contracts_execution_naming.py
  description: 'Contract Check Execution

    ========================


    Functions for executing individual contract checks.


    Check types:

    - regex: Pattern matching

    - lsp_query: LSP-based semantic checks

    - ast_check: AST-based code metrics

    - command: Shell command execution

    - file_exists: File existence checks

    - custom: Custom Python functions


    Extracted from contracts.py for modularity.'
  entities:
  - name: CheckContext
    type: dataclass
    line_number: 33
    description: Context object for check execution, grouping common parameters.
    methods: []
    test_methods: []
  - name: execute_check
    type: function
    line_number: 44
    description: "Execute a single check against the repo or specific files.\n\nArgs:\n\
      \    check: Check configuration from contract\n    repo_root: Repository root\
      \ directory (Path or str)\n    file_paths: Optional list of specific files to\
      \ check\n\nReturns:\n    List of CheckResult for any violations found"
    methods: []
    test_methods: []
- name: contracts
  component_id: agentforge-core-contracts
  location: src/agentforge/core/contracts.py
  test_location: tests/unit/tools/test_contracts_execution_naming.py
  description: 'Contract loading, resolution, and execution for AgentForge.


    Contracts define machine-verifiable code correctness rules that can be:

    - Inherited from builtin contracts (_base, _patterns-csharp, etc.)

    - Defined at global, workspace, or repo level

    - Exempted with documented justifications


    This module provides the high-level API for contract operations.

    For implementation details, see:

    - contracts_types.py: Data classes

    - contracts_registry.py: Contract discovery and loading

    - contracts_execution.py: Check execution

    - contracts_ast.py: AST-based checks

    - contracts_lsp.py: LSP-based checks'
  entities:
  - name: RegistryOptions
    type: dataclass
    line_number: 24
    description: Options for contract registry configuration.
    methods: []
    test_methods: []
  - name: run_contract
    type: function
    line_number: 46
    description: "Run all checks in a contract.\n\nArgs:\n    contract: Contract to\
      \ run\n    repo_root: Repository root directory\n    registry: ContractRegistry\
      \ for exemption lookup\n    file_paths: Optional specific files to check\n\n\
      Returns:\n    ContractResult with all check results"
    methods: []
    test_methods: []
  - name: run_all_contracts
    type: function
    line_number: 97
    description: Run all applicable contracts for a repository.
    methods: []
    test_methods: []
- name: verification_types
  component_id: agentforge-core-verification_types
  location: src/agentforge/core/verification_types.py
  test_location: tests/unit/tools/test_verification_checks.py
  description: 'Verification Types

    ==================


    Data classes and enums for the verification system.


    Extracted from verification_runner.py for modularity.'
  entities:
  - name: Severity
    type: enum
    line_number: 16
    description: ''
    methods: []
    test_methods: []
  - name: CheckStatus
    type: enum
    line_number: 23
    description: ''
    methods: []
    test_methods: []
  - name: CheckResult
    type: dataclass
    line_number: 31
    description: Result of a single verification check.
    methods:
    - passed
    - is_blocking_failure
    test_methods: []
  - name: VerificationReport
    type: dataclass
    line_number: 55
    description: Complete verification report with all check results.
    methods:
    - add_result
    test_methods: []
- name: builtin_checks_architecture
  component_id: agentforge-core-builtin_checks_architecture
  location: src/agentforge/core/builtin_checks_architecture.py
  test_location: tests/unit/tools/test_builtin_checks_architecture.py
  description: 'Architecture-related builtin checks for AgentForge contracts.


    These checks use AST-based semantic analysis to detect:

    - Clean Architecture layer violations

    - Constructor injection patterns

    - Domain layer purity

    - Circular import dependencies'
  entities:
  - name: CycleContext
    type: dataclass
    line_number: 33
    description: Context for cycle detection to reduce parameter passing.
    methods: []
    test_methods: []
  - name: check_layer_imports
    type: function
    line_number: 44
    description: Detect Clean Architecture layer boundary violations using AST import
      analysis.
    methods: []
    test_methods: []
  - name: check_constructor_injection
    type: function
    line_number: 130
    description: Verify that service classes use constructor injection.
    methods: []
    test_methods: []
  - name: check_domain_purity
    type: function
    line_number: 198
    description: Ensure domain layer contains no I/O operations.
    methods: []
    test_methods: []
  - name: check_circular_imports
    type: function
    line_number: 286
    description: Detect circular import dependencies between modules.
    methods: []
    test_methods: []
- name: builtin_checks_architecture_helpers
  component_id: agentforge-core-builtin_checks_architecture_helpers
  location: src/agentforge/core/builtin_checks_architecture_helpers.py
  test_location: tests/unit/tools/test_builtin_checks_architecture.py
  description: 'Helper functions for architecture checks.


    Extracted from builtin_checks_architecture.py to reduce complexity and file length.'
  entities:
  - name: is_stdlib_or_thirdparty
    type: function
    line_number: 36
    description: Check if import is from standard library or third-party package.
    methods: []
    test_methods: []
  - name: get_relative_path
    type: function
    line_number: 42
    description: Get relative path string from file path.
    methods: []
    test_methods: []
  - name: parse_source_safe
    type: function
    line_number: 50
    description: Parse a Python file, returning None on error.
    methods: []
    test_methods: []
  - name: get_layer_for_path
    type: function
    line_number: 59
    description: Determine which layer a file belongs to based on its path.
    methods: []
    test_methods: []
  - name: get_layer_for_import
    type: function
    line_number: 73
    description: Determine which layer an import belongs to based on module name.
    methods: []
    test_methods: []
  - name: extract_import_names
    type: function
    line_number: 85
    description: Extract import names and line numbers from an AST node.
    methods: []
    test_methods: []
  - name: get_call_string
    type: function
    line_number: 94
    description: Get string representation of a function call.
    methods: []
    test_methods: []
  - name: path_to_module
    type: function
    line_number: 115
    description: Convert a file path to a module name.
    methods: []
    test_methods: []
  - name: is_type_checking_block
    type: function
    line_number: 126
    description: Check if an If node is a TYPE_CHECKING guard.
    methods: []
    test_methods: []
  - name: create_violation
    type: function
    line_number: 135
    description: Create a standardized violation dictionary.
    methods: []
    test_methods: []
- name: builtin_checks
  component_id: agentforge-core-builtin_checks
  location: src/agentforge/core/builtin_checks.py
  test_location: tests/unit/tools/test_builtin_checks_architecture.py
  description: "Built-in check implementations for AgentForge contracts.\n\nThese\
    \ functions provide reusable checks that can be invoked from contracts\nusing\
    \ the 'custom' check type. They are specifically designed for tasks\nthat cannot\
    \ be done via LSP (text patterns, file operations, etc.).\n\nNOTE: For semantic\
    \ code analysis (public fields, method naming, etc.),\nuse `lsp_query` check type\
    \ instead - it leverages our LSP adapters for\naccurate, parser-based analysis.\n\
    \nEach function follows the signature:\n    func(repo_root: Path, file_paths:\
    \ List[Path], **params) -> List[Dict]\n\nReturn format:\n    [\n        {\n  \
    \          \"message\": \"Description of the violation\",\n            \"file\"\
    : \"relative/path/to/file.cs\",\n            \"line\": 42,\n            \"severity\"\
    : \"error\",  # Optional, defaults to check's severity\n            \"fix_hint\"\
    : \"How to fix this\"  # Optional\n        }\n    ]"
  entities:
  - name: check_todo_comments
    type: function
    line_number: 36
    description: "Check for TODO/FIXME comments, optionally requiring ticket references.\n\
      \nArgs:\n    require_ticket: If True, TODOs must have a ticket reference\n \
      \   ticket_patterns: Patterns to match ticket references (e.g., ['AB#\\d+',\
      \ 'JIRA-\\d+'])"
    methods: []
    test_methods: []
  - name: check_debug_statements
    type: function
    line_number: 73
    description: "Check for debug statements that shouldn't be committed.\n\nThis\
      \ is appropriate for regex since we're looking for specific text patterns\n\
      like console.log, print(), debugger, etc.\n\nArgs:\n    patterns: Additional\
      \ patterns to check for (beyond defaults)"
    methods: []
    test_methods: []
  - name: check_file_size
    type: function
    line_number: 133
    description: Check that files don't exceed size limits.
    methods: []
    test_methods: []
  - name: check_line_length
    type: function
    line_number: 168
    description: Check that lines don't exceed maximum length.
    methods: []
    test_methods: []
  - name: check_trailing_whitespace
    type: function
    line_number: 193
    description: Check for trailing whitespace.
    methods: []
    test_methods: []
  - name: check_mixed_line_endings
    type: function
    line_number: 218
    description: Check for mixed line endings (CRLF vs LF).
    methods: []
    test_methods: []
  - name: check_hardcoded_secrets
    type: function
    line_number: 250
    description: 'Check for potential hardcoded secrets in code.


      This uses regex patterns to find potential secrets in string literals.

      It''s appropriate for regex since we''re looking for text patterns.'
    methods: []
    test_methods: []
  - name: check_lineage_metadata
    type: function
    line_number: 305
    description: 'Check that files have lineage metadata for audit trail.


      Files generated through TDFLOW or other code generation pipelines should

      have embedded lineage metadata that links them back to their spec.


      The lineage chain is: Spec → Test → Implementation

      Each generated file should have @spec_file, @spec_id, @component_id

      in its header comments.


      This check helps enforce the audit trail, making it possible to trace

      any piece of code back to its requirements and associated tests.'
    methods: []
    test_methods: []
  - name: check_minimal_context_validation
    type: function
    line_number: 390
    description: 'Check that the Minimal Context Architecture has proper validation
      in place.


      Validates that key files contain required validation methods:

      1. EnhancedContextBuilder has _validate_context_integrity

      2. Executor has _validate_response_parameters

      3. PhaseMachine has validate_state


      This ensures runtime validation catches issues early.'
    methods: []
    test_methods: []
  - name: get_builtin_check
    type: function
    line_number: 475
    description: Get a built-in check function by name.
    methods: []
    test_methods: []
  - name: list_builtin_checks
    type: function
    line_number: 480
    description: List all available built-in checks.
    methods: []
    test_methods: []
- name: init
  component_id: agentforge-core-init
  location: src/agentforge/core/init.py
  test_location: tests/unit/harness/test_tool_registry.py
  description: 'Project initialization for AgentForge.


    Handles creating the .agentforge directory structure and populating

    it with default agents and pipelines from package resources.'
  entities:
  - name: get_package_resource_path
    type: function
    line_number: 16
    description: 'Get the path to a package resource.


      Uses importlib.resources for Python 3.11+ compatibility.

      Falls back to file-based paths if resources aren''t bundled.'
    methods: []
    test_methods: []
  - name: initialize_project
    type: function
    line_number: 36
    description: "Initialize an AgentForge project.\n\nCreates the .agentforge directory\
      \ structure and copies default\nconfigurations from package resources.\n\nArgs:\n\
      \    project_path: Root directory for the project. Defaults to CWD.\n    name:\
      \ Project name. Defaults to directory name.\n    force: Overwrite existing .agentforge\
      \ directory.\n\nReturns:\n    Path to the initialized .agentforge directory.\n\
      \nRaises:\n    FileExistsError: If .agentforge exists and force=False."
    methods: []
    test_methods: []
  - name: is_initialized
    type: function
    line_number: 143
    description: "Check if a directory has been initialized for AgentForge.\n\nArgs:\n\
      \    path: Directory to check. Defaults to CWD.\n\nReturns:\n    True if .agentforge\
      \ directory exists."
    methods: []
    test_methods: []
  - name: get_agentforge_dir
    type: function
    line_number: 156
    description: "Find the .agentforge directory for a project.\n\nSearches up the\
      \ directory tree from the given path.\n\nArgs:\n    path: Starting directory.\
      \ Defaults to CWD.\n\nReturns:\n    Path to .agentforge directory, or None if\
      \ not found."
    methods: []
    test_methods: []
