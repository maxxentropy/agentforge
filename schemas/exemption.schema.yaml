$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://agentforge.dev/schemas/exemption.schema.yaml"
title: "Exemption"
description: |
  Approved exception to contract checks with justification and optional expiration.
  Supports scoped exemptions by file pattern, check ID, or specific violations.

  Individual exemptions are stored as {exemption-id}.yaml in .agentforge/exemptions/

type: object
required:
  - schema_version
  - id
  - contract_id
  - check_ids
  - reason
  - approved_by
  - approved_date
  - status
  - scope

properties:
  schema_version:
    type: string
    pattern: "^\\d+\\.\\d+$"

  id:
    type: string
    pattern: "^[a-z][a-z0-9_-]*$"
    description: "Unique exemption identifier"
    examples: ["legacy-console-logging", "test-file-docstrings"]

  contract_id:
    type: string
    pattern: "^[a-z][a-z0-9_-]*$"
    description: "Contract being exempted"

  check_ids:
    type: array
    items:
      type: string
    minItems: 1
    description: "Checks exempted (use '*' for all checks in contract)"
    examples: [["no-print-statements"], ["*"]]

  reason:
    type: string
    minLength: 10
    description: "Justification for the exemption"

  approved_by:
    type: string
    description: "Approver (username, email, or 'self' for acknowledged debt)"
    examples: ["jsmith@example.com", "self"]

  approved_date:
    type: string
    format: date
    description: "ISO 8601 date of approval"

  expires:
    type: string
    format: date
    description: "Optional expiration date (end of day)"

  review_date:
    type: string
    format: date
    description: "Optional date to reconsider exemption"

  status:
    type: string
    enum: [active, expired, resolved, under_review]
    description: "Current exemption status"

  scope:
    type: object
    required: [type]
    properties:
      type:
        type: string
        enum: [check_id, file_pattern, violation_id, global]
        description: "Type of scope restriction"
      patterns:
        type: array
        items:
          type: string
        description: "File glob patterns (for file_pattern type)"
        examples: [["tests/**/*.py", "scripts/*.py"]]
      violation_ids:
        type: array
        items:
          type: string
          pattern: "^V-[a-f0-9]{12}(-\\d+)?$"
        description: "Specific violation IDs (for violation_id type)"
      lines:
        type: object
        properties:
          start:
            type: integer
            minimum: 1
          end:
            type: integer
            minimum: 1
        description: "Optional line range restriction"

  notes:
    type: string
    description: "Additional context or tracking information"

  ticket:
    type: string
    description: "Reference to tracking ticket"
    examples: ["JIRA-1234", "AB#5678"]

  tags:
    type: array
    items:
      type: string
    description: "Tags for categorizing exemptions"

additionalProperties: false

examples:
  - schema_version: "1.0"
    id: "legacy-console-logging"
    contract_id: "agentforge"
    check_ids: ["no-print-statements"]
    reason: "Legacy CLI module uses print for user output. Will migrate to rich in Q2."
    approved_by: "tech-lead@example.com"
    approved_date: "2025-01-01"
    expires: "2025-03-31"
    review_date: "2025-03-01"
    status: "active"
    scope:
      type: "file_pattern"
      patterns:
        - "cli/**/*.py"
