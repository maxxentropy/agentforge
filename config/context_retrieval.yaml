# Context Retrieval Configuration
# ================================
# Hybrid LSP + Vector retrieval for code context.
# "Correctness is Upstream" - agents need real code to write accurate specs.
#
# Schema: schemas/context_retrieval.schema.yaml

# =============================================================================
# LSP (Language Server Protocol) Configuration
# =============================================================================
# This is the core - provides compiler-accurate code intelligence.
# LSP gives us the compiler's view of the code, which is the only source of truth.

lsp:
  # Primary language for this project (auto-detected if not specified)
  primary_language: csharp

  servers:
    # C# - PRIMARY TARGET
    # csharp-ls is lightweight and fast, better for our use case than OmniSharp
    csharp:
      name: "csharp-ls"
      command: "csharp-ls"
      args: []
      file_extensions: [".cs", ".csx"]
      enabled: true
      install_instructions: "dotnet tool install -g csharp-ls"

    # Python
    python:
      name: "Pyright"
      command: "pyright-langserver"
      args: ["--stdio"]
      file_extensions: [".py", ".pyi"]
      enabled: true
      install_instructions: "pip install pyright"

    # TypeScript/JavaScript
    typescript:
      name: "TypeScript Language Server"
      command: "typescript-language-server"
      args: ["--stdio"]
      file_extensions: [".ts", ".tsx", ".js", ".jsx"]
      enabled: true
      install_instructions: "npm install -g typescript-language-server typescript"

  # LSP operations and their timeouts
  operations:
    document_symbols:
      method: "textDocument/documentSymbol"
      use_case: "Get all symbols in a file"
      timeout_ms: 5000

    workspace_symbols:
      method: "workspace/symbol"
      use_case: "Search for symbols across workspace"
      timeout_ms: 10000

    definition:
      method: "textDocument/definition"
      use_case: "Find where symbol is defined"
      timeout_ms: 2000

    references:
      method: "textDocument/references"
      use_case: "Find all usages of symbol"
      timeout_ms: 10000

    hover:
      method: "textDocument/hover"
      use_case: "Get type info and documentation"
      timeout_ms: 2000

# =============================================================================
# Semantic Search Configuration
# =============================================================================
# Semantic search complements LSP's structural queries.
# LSP answers: "where is OrderService defined?"
# Vector answers: "what code is related to discount handling?"

semantic:
  enabled: true

  # Embedding provider: "local", "openai", "voyage", or null (auto-select)
  # Auto-select priority: voyage (if VOYAGE_API_KEY set) > openai (if OPENAI_API_KEY set) > local
  # Default: local (no API key needed, code stays on your machine)
  embedding_provider: null

  # Local provider settings (sentence-transformers)
  # No API key needed. Model downloads ~80MB on first use.
  local:
    model: "all-MiniLM-L6-v2"  # Fast, good quality, 384 dimensions
    # Alternatives:
    # - all-mpnet-base-v2: Better quality, slower, 768 dimensions
    # - codeparrot/codebert-base: Optimized for code, 768 dimensions

  # OpenAI provider settings (requires OPENAI_API_KEY)
  openai:
    model: "text-embedding-3-small"  # 1536 dimensions, ~$0.02/1M tokens

  # Voyage AI provider settings (requires VOYAGE_API_KEY)
  # Anthropic's recommended embedding partner, optimized for code
  voyage:
    model: "voyage-code-2"  # 1024 dimensions, ~$0.02/1M tokens

  # Code chunking strategy
  chunking:
    strategy: "ast_aware"  # ast_aware | sliding_window

    ast_aware:
      max_chunk_tokens: 500
      min_chunk_tokens: 50
      include_signature: true
      include_docstring: true

    sliding_window:
      window_size_tokens: 400
      overlap_tokens: 100

  # Index storage location (provider name is appended automatically)
  index_path: ".agentforge/vector_index"

# =============================================================================
# Retrieval Configuration
# =============================================================================

retrieval:
  # How to combine LSP and vector results
  fusion:
    strategy: "reciprocal_rank"  # reciprocal_rank | weighted | cascade

    reciprocal_rank:
      k: 60  # RRF constant

    weights:
      lsp: 0.6      # Structural results get higher weight
      vector: 0.4   # Semantic results complement

  # Token budget management
  budget:
    default_tokens: 6000
    max_tokens: 12000

    # How to allocate budget across result types
    allocation:
      primary_components: 0.50    # Components being modified
      related_components: 0.25    # Components that interact
      pattern_examples: 0.15      # Example code for patterns
      documentation: 0.10         # Relevant docs

# =============================================================================
# File Filtering
# =============================================================================

filters:
  include_patterns:
    - "**/*.cs"
    - "**/*.py"
    - "**/*.ts"
    - "**/*.js"
    - "**/*.java"

  exclude_patterns:
    - "**/bin/**"
    - "**/obj/**"
    - "**/node_modules/**"
    - "**/.git/**"
    - "**/packages/**"
    - "**/dist/**"
    - "**/build/**"
    - "**/__pycache__/**"
    - "**/test*/**"        # Exclude tests by default
    - "**/*Test*.cs"
    - "**/*Tests*.cs"

  exclude_files:
    - "*.Designer.cs"
    - "*.g.cs"
    - "AssemblyInfo.cs"
    - "GlobalUsings.cs"

# =============================================================================
# Layer Detection (Clean Architecture)
# =============================================================================
# Used to categorize files by architectural layer for better context organization.

layer_detection:
  patterns:
    Domain:
      - "**/Domain/**"
      - "**/Entities/**"
      - "**/Core/**"
      - "**/Models/**"
      - "**/ValueObjects/**"
      - "**/Aggregates/**"

    Application:
      - "**/Application/**"
      - "**/UseCases/**"
      - "**/Services/**"
      - "**/Commands/**"
      - "**/Queries/**"
      - "**/Handlers/**"
      - "**/Features/**"

    Infrastructure:
      - "**/Infrastructure/**"
      - "**/Persistence/**"
      - "**/External/**"
      - "**/Data/**"
      - "**/Repositories/**"
      - "**/Adapters/**"

    Presentation:
      - "**/Presentation/**"
      - "**/Api/**"
      - "**/Controllers/**"
      - "**/Web/**"
      - "**/UI/**"
      - "**/Endpoints/**"

# =============================================================================
# Indexing Configuration
# =============================================================================

indexing:
  # Storage location
  storage:
    base_path: ".agentforge"
    vector_index: "vector_index"

  # Cache settings
  cache:
    enabled: true
    invalidate_on_file_change: true
